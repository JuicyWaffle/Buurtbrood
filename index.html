<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Buurtbrood Planner</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  
  :root {
    --cream: #F5F0E8;
    --warm-white: #FAF7F2;
    --dark: #1A1410;
    --brown: #5C3D2E;
    --amber: #C8840A;
    --amber-light: #E8A520;
    --rust: #A0522D;
    --sage: #7A8C6E;
    --crust: #8B6914;
    --flour: #EDE8DC;
    --border: #D4C9B0;
    --text-muted: #8B7355;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--dark);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grain texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
    opacity: 0.5;
  }

  /* Layout */
  .app { display: flex; min-height: 100vh; }

  /* Sidebar */
  .sidebar {
    width: 220px;
    flex-shrink: 0;
    background: var(--dark);
    display: flex;
    flex-direction: column;
    padding: 0;
    position: sticky;
    top: 0;
    height: 100vh;
    overflow: hidden;
  }

  .sidebar-logo { width:72px; height:72px; border-radius:14px; object-fit:cover; border:2px solid rgba(255,255,255,0.12); box-shadow:0 4px 16px rgba(0,0,0,0.4); display:block; margin:0 auto 10px; }
  .sidebar-brand {
    padding: 20px 16px 18px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .sidebar-brand h1 {
    font-family: 'DM Serif Display', serif;
    font-style: italic;
    color: var(--amber-light);
    font-size: 18px;
    line-height: 1.1;
  }
  .sidebar-brand p {
    color: rgba(255,255,255,0.35);
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-top: 4px;
  }

  .sidebar-nav { padding: 16px 12px; flex: 1; display: flex; flex-direction: column; gap: 2px; }
  
  .nav-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    border: none;
    background: none;
    color: rgba(255,255,255,0.5);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 400;
    cursor: pointer;
    transition: all 0.15s;
    text-align: left;
    width: 100%;
  }
  .nav-btn:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.85); }
  .nav-btn.active { background: var(--amber); color: var(--dark); font-weight: 500; }
  .nav-btn .icon { font-size: 16px; width: 20px; text-align: center; }

  .nav-section-label {
    color: rgba(255,255,255,0.2);
    font-size: 9px;
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 12px 12px 4px;
  }

  /* Main content */
  .main { flex: 1; padding: 32px 40px; overflow-y: auto; }

  .page-header { margin-bottom: 32px; }
  .page-header h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 32px;
    color: var(--dark);
    line-height: 1;
  }
  .page-header p { color: var(--text-muted); font-size: 13px; margin-top: 4px; }

  /* Cards */
  .card {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
  }

  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  
  .stat-card {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }
  .stat-card .label { font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; }
  .stat-card .value { font-family: 'DM Serif Display', serif; font-size: 36px; color: var(--dark); margin-top: 4px; line-height: 1; }
  .stat-card .sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

  /* Orders */
  .orders-grid { display: flex; flex-direction: column; gap: 12px; }
  
  .order-card {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: border-color 0.15s;
    cursor: pointer;
  }
  .order-card:hover { border-color: var(--amber); }
  .order-card.selected { border-color: var(--amber); background: #FFF8EC; }

  .order-num { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-muted); width: 60px; }
  .order-customer { flex: 1; }
  .order-customer strong { font-size: 14px; font-weight: 500; display: block; }
  .order-customer span { font-size: 12px; color: var(--text-muted); }
  .order-items { font-size: 12px; color: var(--text-muted); flex: 2; }
  .order-total { font-family: 'DM Serif Display', serif; font-size: 20px; color: var(--amber); min-width: 70px; text-align: right; }

  .badge {
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    font-weight: 500;
    white-space: nowrap;
  }
  .badge-new { background: #EFF6FF; color: #1D4ED8; border: 1px solid #BFDBFE; }
  .badge-production { background: #FEF3C7; color: #92400E; border: 1px solid #FDE68A; }
  .badge-ready { background: #D1FAE5; color: #065F46; border: 1px solid #6EE7B7; }
  .badge-delivered { background: var(--flour); color: var(--text-muted); border: 1px solid var(--border); }
  .badge-b2b { background: #F3E8FF; color: #6B21A8; border: 1px solid #DDD6FE; }
  .badge-b2c { background: #FFF1F2; color: #9F1239; border: 1px solid #FECDD3; }

  /* Production plan */
  .bake-session {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 12px;
    overflow: hidden;
  }
  .bake-session-header {
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 1px solid var(--border);
    background: var(--flour);
  }
  .bake-session-header h3 { font-family: 'DM Serif Display', serif; font-size: 18px; flex: 1; }
  .bake-session-body { padding: 16px 24px; }
  .bake-row { display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--flour); }
  .bake-row:last-child { border-bottom: none; }
  .bake-product { font-size: 13px; flex: 1; font-weight: 500; }
  .bake-qty { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--text-muted); min-width: 80px; }
  .bake-flour { font-size: 12px; color: var(--text-muted); }

  /* Timers */
  .timers-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .timer-card {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .timer-card.running { border-color: var(--amber); }
  .timer-card.done { border-color: var(--sage); background: #F0F4EE; }
  .timer-card h3 { font-family: 'DM Serif Display', serif; font-size: 16px; margin-bottom: 4px; }
  .timer-card .phase { font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 16px; }
  .timer-display { font-family: 'DM Mono', monospace; font-size: 42px; font-weight: 500; color: var(--dark); line-height: 1; }
  .timer-display.running { color: var(--amber); }
  .timer-display.done { color: var(--sage); }
  .timer-progress { height: 4px; background: var(--flour); border-radius: 2px; margin: 16px 0; overflow: hidden; }
  .timer-progress-fill { height: 100%; background: var(--amber); border-radius: 2px; transition: width 1s linear; }
  .timer-progress-fill.done { background: var(--sage); }
  .timer-btns { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
  .btn { padding: 8px 16px; border-radius: 8px; border: none; font-size: 12px; font-family: 'DM Sans', sans-serif; font-weight: 500; cursor: pointer; transition: all 0.15s; }
  .btn-primary { background: var(--amber); color: white; }
  .btn-primary:hover { background: var(--crust); }
  .btn-secondary { background: var(--flour); color: var(--dark); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-danger { background: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; }
  .btn-danger:hover { background: #FECACA; }

  /* Inventory */
  .inventory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  .ingredient-card {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
  }
  .ingredient-card.low { border-color: #FCA5A5; background: #FFF5F5; }
  .ingredient-card .name { font-weight: 500; font-size: 14px; }
  .ingredient-card .stock { font-family: 'DM Serif Display', serif; font-size: 28px; color: var(--amber); margin-top: 2px; }
  .ingredient-card .stock.low { color: #DC2626; }
  .ingredient-card .unit { font-size: 12px; color: var(--text-muted); }
  .ingredient-card .cost { font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text-muted); margin-top: 8px; }
  .stock-bar { height: 3px; background: var(--flour); border-radius: 2px; margin-top: 8px; }
  .stock-bar-fill { height: 100%; border-radius: 2px; }

  /* Labels */
  .label-preview {
    width: 240px;
    height: 140px;
    background: white;
    border: 2px solid var(--dark);
    border-radius: 8px;
    padding: 16px;
    font-family: 'DM Sans', sans-serif;
    display: inline-block;
    margin: 8px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
  }
  .label-preview::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 6px;
    background: var(--amber);
  }
  .label-preview:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
  .label-preview h4 { font-family: 'DM Serif Display', serif; font-size: 18px; margin-top: 8px; }
  .label-preview .weight { font-size: 11px; color: var(--text-muted); font-family: 'DM Mono', monospace; }
  .label-preview .price { font-size: 22px; font-family: 'DM Serif Display', serif; color: var(--amber); position: absolute; bottom: 12px; right: 16px; }
  .label-preview .bakery-name { font-size: 9px; color: var(--text-muted); font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 0.15em; }

  /* Toolbar */
  .toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
  .toolbar-spacer { flex: 1; }

  .search-input {
    padding: 8px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--warm-white);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    color: var(--dark);
    outline: none;
    width: 220px;
  }
  .search-input:focus { border-color: var(--amber); }

  .select-input {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--warm-white);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    color: var(--dark);
    outline: none;
    cursor: pointer;
  }

  /* Loading spinner */
  .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--amber); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 40px auto; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg { background: #FEE2E2; border: 1px solid #FECACA; border-radius: 8px; padding: 16px; color: #991B1B; font-size: 13px; }
  .empty-msg { text-align: center; padding: 60px; color: var(--text-muted); }
  .empty-msg .icon { font-size: 48px; margin-bottom: 12px; }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
  .modal { background: var(--warm-white); border-radius: 16px; padding: 32px; width: 520px; max-height: 80vh; overflow-y: auto; }
  .modal h3 { font-family: 'DM Serif Display', serif; font-size: 24px; margin-bottom: 20px; }
  .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); }

  .order-detail-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--flour); font-size: 14px; }
  .order-detail-item:last-child { border-bottom: none; }

  /* Status select */
  .status-select {
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    background: var(--flour);
    cursor: pointer;
    outline: none;
  }

  /* â”€â”€ Workflow editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .wf-product-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
  .wf-product-row {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    transition: border-color 0.15s;
  }
  .wf-product-row:hover { border-color: var(--amber); }
  .wf-product-row.active { border-color: var(--amber); background: #FFF8EC; }
  .wf-product-name { flex: 1; font-weight: 500; font-size: 14px; }
  .wf-product-steps { font-size: 12px; color: var(--text-muted); font-family: 'DM Mono', monospace; }

  .wf-editor {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .wf-editor-header {
    padding: 18px 24px;
    background: var(--flour);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .wf-editor-header h3 { font-family: 'DM Serif Display', serif; font-size: 20px; flex: 1; }
  .wf-editor-body { padding: 20px 24px; }

  .wf-step {
    display: grid;
    grid-template-columns: 28px 160px 90px 130px 130px 36px;
    gap: 10px;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--flour);
  }
  .wf-step:last-child { border-bottom: none; }
  .wf-step-num {
    width: 26px; height: 26px;
    border-radius: 50%;
    background: var(--dark);
    color: white;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .wf-step-num.kneden  { background: #7C3AED; }
  .wf-step-num.vouwen  { background: #0369A1; }
  .wf-step-num.rijzen  { background: #047857; }
  .wf-step-num.bakken  { background: #B91C1C; }

  .wf-step-type-select, .wf-step-input {
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 7px;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--dark);
    outline: none;
    width: 100%;
  }
  .wf-step-type-select:focus, .wf-step-input:focus { border-color: var(--amber); }

  .wf-step-label { font-size: 11px; color: var(--text-muted); font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 2px; }

  .wf-add-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 16px;
    border: 1px dashed var(--border);
    border-radius: 8px;
    background: none;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 10px;
    width: 100%;
    transition: all 0.15s;
  }
  .wf-add-btn:hover { border-color: var(--amber); color: var(--amber); background: #FFF8EC; }

  .wf-step-col-headers {
    display: grid;
    grid-template-columns: 28px 160px 90px 130px 130px 36px;
    gap: 10px;
    padding: 0 0 8px 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 4px;
  }

  /* â”€â”€ 3-day planning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .plan3-layout { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }

  .day-col {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .day-col-header {
    padding: 14px 18px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    border-bottom: 1px solid var(--border);
  }
  .day-col-header.t2 { background: #EFF6FF; border-bottom-color: #BFDBFE; }
  .day-col-header.t1 { background: #FFF7ED; border-bottom-color: #FED7AA; }
  .day-col-header.t0 { background: #FEF2F2; border-bottom-color: #FECACA; }
  .day-col-label { font-size: 10px; font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 0.12em; }
  .day-col-label.t2 { color: #1D4ED8; }
  .day-col-label.t1 { color: #C2410C; }
  .day-col-label.t0 { color: #B91C1C; }
  .day-col-date { font-family: 'DM Serif Display', serif; font-size: 18px; }
  .day-col-body { padding: 12px; display: flex; flex-direction: column; gap: 8px; }

  .plan-step-block {
    border-radius: 8px;
    padding: 10px 14px;
    border-left: 3px solid;
    position: relative;
  }
  .plan-step-block.kneden { background: #F5F3FF; border-color: #7C3AED; }
  .plan-step-block.vouwen { background: #EFF6FF; border-color: #0369A1; }
  .plan-step-block.rijzen { background: #ECFDF5; border-color: #047857; }
  .plan-step-block.bakken { background: #FEF2F2; border-color: #B91C1C; }

  .plan-step-product { font-size: 10px; font-family: 'DM Mono', monospace; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 2px; }
  .plan-step-name { font-size: 13px; font-weight: 500; }
  .plan-step-window { font-size: 11px; color: var(--text-muted); margin-top: 3px; font-family: 'DM Mono', monospace; }
  .plan-step-duration { font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text-muted); margin-top: 2px; }

  .plan-empty-day { text-align: center; padding: 30px 16px; color: var(--text-muted); font-size: 12px; }

  .step-type-dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 5px;
    flex-shrink: 0;
  }
  .dot-kneden { background: #7C3AED; }
  .dot-vouwen { background: #0369A1; }
  .dot-rijzen { background: #047857; }
  .dot-bakken { background: #B91C1C; }

  /* â”€â”€ Kalender â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .cal-week-grid {
    display: grid;
    grid-template-columns: 64px repeat(7, 1fr);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    background: var(--warm-white);
    margin-bottom: 24px;
  }
  .cal-week-header {
    background: var(--flour);
    border-bottom: 1px solid var(--border);
    padding: 10px 8px;
    text-align: center;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }
  .cal-week-header.today { background: var(--amber); color: white; }
  .cal-week-corner {
    background: var(--flour);
    border-bottom: 1px solid var(--border);
    border-right: 1px solid var(--border);
  }
  .cal-time-label {
    border-right: 1px solid var(--border);
    padding: 0 8px;
    display: flex;
    align-items: flex-start;
    padding-top: 4px;
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    color: var(--text-muted);
    height: 48px;
    border-bottom: 1px solid var(--flour);
  }
  .cal-day-col {
    border-right: 1px solid var(--flour);
    position: relative;
    min-height: 48px;
    cursor: pointer;
    transition: background 0.1s;
  }
  .cal-day-col:last-child { border-right: none; }
  .cal-day-col:hover { background: #FFF8EC; }
  .cal-day-col.today-col { background: rgba(200,132,10,0.04); }

  /* Week summary cards */
  .cal-week-summary {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 20px;
  }
  .cal-day-card {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.15s;
    min-height: 90px;
  }
  .cal-day-card:hover { border-color: var(--amber); transform: translateY(-1px); }
  .cal-day-card.today { border-color: var(--amber); background: #FFF8EC; }
  .cal-day-card.selected { border-color: var(--amber); box-shadow: 0 0 0 2px rgba(200,132,10,0.25); }
  .cal-day-card.empty { opacity: 0.5; }
  .cal-day-name { font-size: 10px; font-family: 'DM Mono', monospace; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; }
  .cal-day-num { font-family: 'DM Serif Display', serif; font-size: 22px; line-height: 1; margin: 2px 0 6px; }
  .cal-day-chips { display: flex; flex-direction: column; gap: 3px; }
  .cal-chip {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cal-chip.t2 { background: #EFF6FF; color: #1D4ED8; }
  .cal-chip.t1 { background: #FFF7ED; color: #C2410C; }
  .cal-chip.t0 { background: #FEF2F2; color: #B91C1C; }
  .cal-chip.bake { background: #FEF2F2; color: #B91C1C; font-weight: 600; }

  /* Day detail panel */
  .cal-day-detail {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .cal-detail-header {
    padding: 16px 24px;
    background: var(--dark);
    color: white;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .cal-detail-header h3 { font-family: 'DM Serif Display', serif; font-size: 22px; flex: 1; font-style: italic; }
  .cal-detail-body { padding: 20px 24px; }

  .cal-block-group { margin-bottom: 20px; }
  .cal-block-group-header {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-muted);
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .cal-role-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .cal-role-badge.t2 { background: #DBEAFE; color: #1E40AF; }
  .cal-role-badge.t1 { background: #FFEDD5; color: #9A3412; }
  .cal-role-badge.t0 { background: #FEE2E2; color: #991B1B; }

  .cal-activity-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--flour);
  }
  .cal-activity-row:last-child { border-bottom: none; }
  .cal-activity-time {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    min-width: 80px;
    padding-top: 2px;
  }
  .cal-activity-content { flex: 1; }
  .cal-activity-title { font-size: 13px; font-weight: 500; }
  .cal-activity-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-family: 'DM Mono', monospace; }
  .cal-oven-block {
    background: #FEF2F2;
    border: 1px solid #FECACA;
    border-left: 3px solid #B91C1C;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 4px 0;
    font-size: 12px;
  }
  .cal-oven-block strong { color: #991B1B; }

  /* Nav week */
  .cal-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
  .cal-nav h3 { font-family: 'DM Serif Display', serif; font-size: 22px; flex: 1; }

  /* â”€â”€ IngrediÃ«ntenlijst â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ing-section { margin-bottom: 28px; }
  .ing-section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    background: var(--dark);
    border-radius: 10px 10px 0 0;
    color: white;
  }
  .ing-section-header h3 { font-family: 'DM Serif Display', serif; font-size: 18px; flex: 1; font-style: italic; }
  .ing-section-header .qty-badge { font-family: 'DM Mono', monospace; font-size: 12px; background: rgba(255,255,255,0.15); padding: 3px 10px; border-radius: 10px; }
  .ing-table {
    width: 100%;
    border: 1px solid var(--border);
    border-top: none;
    border-radius: 0 0 10px 10px;
    overflow: hidden;
    border-collapse: collapse;
    background: var(--warm-white);
  }
  .ing-table th {
    text-align: left;
    padding: 10px 16px;
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    background: var(--flour);
    border-bottom: 1px solid var(--border);
    font-weight: 500;
  }
  .ing-table td {
    padding: 10px 16px;
    font-size: 13px;
    border-bottom: 1px solid var(--flour);
    vertical-align: middle;
  }
  .ing-table tr:last-child td { border-bottom: none; }
  .ing-table tr:hover td { background: #FFF8EC; }
  .ing-amount { font-family: 'DM Mono', monospace; font-weight: 500; font-size: 14px; }
  .ing-subtotal-row td { background: var(--flour); font-weight: 600; font-size: 13px; border-top: 1px solid var(--border); }

  .ing-grand-total {
    background: var(--dark);
    color: white;
    border-radius: 10px;
    padding: 16px 20px;
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }
  .ing-grand-total-item { }
  .ing-grand-total-item .label { font-size: 10px; font-family: 'DM Mono', monospace; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.1em; }
  .ing-grand-total-item .val { font-family: 'DM Serif Display', serif; font-size: 22px; color: var(--amber-light); }
  .ing-grand-total-item .unit { font-size: 12px; color: rgba(255,255,255,0.5); }

  /* Print styles */
  @media print {
    .sidebar, .toolbar, .modal-overlay { display: none !important; }
    .main { padding: 0; }
    .label-preview { break-inside: avoid; }
  }

  .divider { height: 1px; background: var(--border); margin: 20px 0; }
  .row { display: flex; gap: 16px; align-items: flex-start; }
  .col { flex: 1; }

  .profit-pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-family: 'DM Mono', monospace; }
  .profit-high { background: #D1FAE5; color: #065F46; }
  .profit-med { background: #FEF3C7; color: #92400E; }

  /* Animate in */
  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  .page-enter { animation: fadeUp 0.25s ease both; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

let API_KEY = '';
const API_BASE = 'https://take.app/api/platform';

// â”€â”€â”€ Local persistence via Node server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LOCAL = {
  async load(key) {
    try {
      const r = await fetch('/api/' + key);
      if (!r.ok) throw new Error();
      return r.json();
    } catch { return null; }
  },
  async save(key, data) {
    try {
      await fetch('/api/' + key, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
    } catch (e) { console.error('Opslaan mislukt:', key, e); }
  },
};

// â”€â”€â”€ Default product catalog (overridden by products.json) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_PRODUCTS = {
  // GROOT B2C
  'spelt-groot': { name: 'Spelt Groot', category: 'GROOT', type: 'sourdough', price_b2c: 5.50, price_b2b: 3.30, flour_kg: 0.5, flour_type: 'spelt', flour_cost_kg: 2.28, weight_g: 850, per_session: 9, session_min: 50, session_cost: 1.50 },
  'spelt-energy-groot': { name: 'Spelt Energy Groot', category: 'GROOT', type: 'sourdough', price_b2c: 5.90, price_b2b: 3.50, flour_kg: 0.5, flour_type: 'spelt_energy', flour_cost_kg: 3.40, weight_g: 850, per_session: 9, session_min: 50, session_cost: 1.50 },
  'wit-groot': { name: 'Wit Groot', category: 'GROOT', type: 'sourdough', price_b2c: 5.00, price_b2b: 3.00, flour_kg: 0.5, flour_type: 'wit', flour_cost_kg: 0.80, weight_g: 550, per_session: 9, session_min: 50, session_cost: 1.50 },
  'bruin-groot': { name: 'Bruin Groot', category: 'GROOT', type: 'sourdough', price_b2c: 5.00, price_b2b: 3.00, flour_kg: 0.5, flour_type: 'bruin', flour_cost_kg: 0.80, weight_g: 550, per_session: 9, session_min: 50, session_cost: 1.50 },
  'rogge': { name: 'Rogge', category: 'GROOT', type: 'sourdough', price_b2c: 5.20, price_b2b: 3.10, flour_kg: 0.25, flour_type: 'rogge', flour_cost_kg: 1.50, weight_g: 600, per_session: 15, session_min: 60, session_cost: 1.50 },
  // KLEIN B2C
  'spelt-klein': { name: 'Spelt Klein', category: 'KLEIN', type: 'sourdough', price_b2c: 5.00, price_b2b: 3.00, flour_kg: 0.4, flour_type: 'spelt', flour_cost_kg: 2.28, weight_g: 600, per_session: 12, session_min: 50, session_cost: 1.50 },
  'spelt-energy-klein': { name: 'Spelt Energy Klein', category: 'KLEIN', type: 'sourdough', price_b2c: 5.50, price_b2b: 3.10, flour_kg: 0.4, flour_type: 'spelt_energy', flour_cost_kg: 3.40, weight_g: 550, per_session: 12, session_min: 50, session_cost: 1.50 },
  'wit-klein': { name: 'Wit Klein', category: 'KLEIN', type: 'sourdough', price_b2c: 4.30, price_b2b: 2.80, flour_kg: 0.4, flour_type: 'wit', flour_cost_kg: 0.80, weight_g: 550, per_session: 12, session_min: 50, session_cost: 1.50 },
  'bruin-klein': { name: 'Bruin Klein', category: 'KLEIN', type: 'sourdough', price_b2c: 4.30, price_b2b: 2.80, flour_kg: 0.4, flour_type: 'bruin', flour_cost_kg: 0.80, weight_g: 550, per_session: 12, session_min: 50, session_cost: 1.50 },
  'vijg-noot': { name: 'Vijg/Noot', category: 'SPECIAAL', type: 'sourdough', price_b2c: 5.90, price_b2b: 3.50, flour_kg: 0.24, flour_type: 'wit', flour_cost_kg: 1.40, weight_g: 550, per_session: 12, session_min: 30, session_cost: 1.50 },
  'pistolet': { name: 'Pistolet', category: 'SPECIAAL', type: 'roll', price_b2c: 0.90, price_b2b: null, flour_kg: 0.08, flour_type: 'wit', flour_cost_kg: 0.80, weight_g: 150, per_session: 25, session_min: 35, session_cost: 1.00 },
  'kaneelkoek': { name: 'Kaneelkoek', category: 'SPECIAAL', type: 'cake', price_b2c: 2.80, price_b2b: null, flour_kg: 0.05, flour_type: 'wit', flour_cost_kg: 0.80, weight_g: null, per_session: 21, session_min: 15, session_cost: 0.30 },
};

const DEFAULT_INVENTORY = [
  { id: 'spelt', name: 'Speltmeel', unit: 'kg', cost_kg: 2.28, stock_kg: 25, min_stock: 10 },
  { id: 'spelt_energy', name: 'Spelt Energy', unit: 'kg', cost_kg: 3.40, stock_kg: 15, min_stock: 8 },
  { id: 'wit', name: 'Witte bloem', unit: 'kg', cost_kg: 0.80, stock_kg: 50, min_stock: 20 },
  { id: 'bruin', name: 'Bruine bloem', unit: 'kg', cost_kg: 0.80, stock_kg: 30, min_stock: 15 },
  { id: 'rogge', name: 'Roggemeel', unit: 'kg', cost_kg: 1.50, stock_kg: 12, min_stock: 8 },
  { id: 'vijg_noot_mix', name: 'Vijgen/Noten mix', unit: 'kg', cost_kg: 3.50, stock_kg: 5, min_stock: 3 },
  { id: 'zout', name: 'Zout', unit: 'kg', cost_kg: 0.40, stock_kg: 8, min_stock: 3 },
  { id: 'desem', name: 'Zuurdesemstarter', unit: 'kg', cost_kg: 0, stock_kg: 4, min_stock: 2 },
  { id: 'kaneel', name: 'Kaneelsuiker mix', unit: 'kg', cost_kg: 2.20, stock_kg: 3, min_stock: 2 },
  { id: 'verpakking_brood', name: 'Verpakking brood', unit: 'stuks', cost_kg: 0.06, stock_kg: 200, min_stock: 80 },
  { id: 'verpakking_koek', name: 'Verpakking koek', unit: 'stuks', cost_kg: 0.10, stock_kg: 60, min_stock: 30 },
];

// â”€â”€â”€ TIMER PRESETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TIMER_PRESETS = [
  { id: 'autolyse', label: 'Autolyse', duration_min: 60, phase: 'Mengen', color: '#C8840A' },
  { id: 'bulkrise', label: 'Bulk Fermentatie', duration_min: 240, phase: 'Rijzen', color: '#5C3D2E' },
  { id: 'retard', label: 'Koelkast Rijs', duration_min: 720, phase: 'Koud rijzen', color: '#7A8C6E' },
  { id: 'proof', label: 'Tweede Rijs', duration_min: 90, phase: 'Rijzen', color: '#A0522D' },
  { id: 'preheat', label: 'Oven Voorverwarmen', duration_min: 45, phase: 'Bakken', color: '#DC2626' },
  { id: 'bake1', label: 'Bakken (met stoom)', duration_min: 20, phase: 'Bakken', color: '#DC2626' },
  { id: 'bake2', label: 'Bakken (zonder stoom)', duration_min: 30, phase: 'Bakken', color: '#DC2626' },
  { id: 'cool', label: 'Afkoelen', duration_min: 90, phase: 'Afkoelen', color: '#7A8C6E' },
];

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) { return new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' }).format(n); }
function fmtTime(secs) {
  if (secs <= 0) return '00:00';
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  const s = secs % 60;
  if (h > 0) return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// Match Take App product names to our catalog
function matchProduct(name) {
  if (!name) return null;
  const n = name.toLowerCase();
  if (n.includes('spelt energy') && (n.includes('groot') || n.includes('large'))) return 'spelt-energy-groot';
  if (n.includes('spelt energy')) return 'spelt-energy-klein';
  if (n.includes('spelt') && (n.includes('groot') || n.includes('large'))) return 'spelt-groot';
  if (n.includes('spelt')) return 'spelt-klein';
  if (n.includes('wit') && (n.includes('groot') || n.includes('large'))) return 'wit-groot';
  if (n.includes('wit')) return 'wit-klein';
  if (n.includes('bruin') && (n.includes('groot') || n.includes('large'))) return 'bruin-groot';
  if (n.includes('bruin')) return 'bruin-klein';
  if (n.includes('rogge')) return 'rogge';
  if (n.includes('vijg') || n.includes('noot')) return 'vijg-noot';
  if (n.includes('pistolet')) return 'pistolet';
  if (n.includes('kaneel')) return 'kaneelkoek';
  return null;
}

// â”€â”€â”€ API (via server proxy â€” geen CORS problemen) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiGet(endpoint) {
  const r = await fetch(`/proxy${endpoint}`);
  if (!r.ok) {
    const err = await r.json().catch(() => ({}));
    throw new Error(err.error || `API fout: ${r.status}`);
  }
  return r.json();
}
async function apiPut(endpoint, body) {
  const r = await fetch(`/proxy${endpoint}`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
  });
  if (!r.ok) {
    const err = await r.json().catch(() => ({}));
    throw new Error(err.error || `API fout: ${r.status}`);
  }
  return r.json();
}

// â”€â”€â”€ Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function NavBtn({ icon, label, active, onClick }) {
  return <button className={`nav-btn ${active ? 'active' : ''}`} onClick={onClick}>
    <span className="icon">{icon}</span> {label}
  </button>;
}

// â”€â”€â”€ Shared order helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const getCustomer = o => o.customer?.name || o.customerName || o.customer_name || o.name || 'Onbekend';
const getTotal    = o => {
  // Take App returns totalAmount in cents
  const raw = o.totalAmount ?? o.total_price ?? o.total ?? 0;
  // Manual B2B orders store euros directly (small numbers), Take App sends cents (large numbers)
  return o.source === 'manual' ? raw : raw / 100;
};
const getType     = o => o.customer_type === 'b2b' || o.is_b2b ? 'b2b' : 'b2c';
const getItems    = o => (o.items || o.order_items || []).map(i => `${i.quantity||i.qty||1}Ã— ${i.name||i.product_name||'?'}`).join(', ');
// Normalize Take App status to our internal status
const normalizeStatus = s => {
  if (!s) return 'new';
  const map = {
    'ORDER_STATUS_PENDING':   'new',
    'ORDER_STATUS_CONFIRMED': 'confirmed',
    'ORDER_STATUS_FULFILLED': 'delivered',
    'ORDER_STATUS_CANCELLED': 'cancelled',
    'new': 'new', 'confirmed': 'confirmed', 'ready': 'ready',
    'delivered': 'delivered', 'pending': 'new', 'cancelled': 'cancelled',
  };
  return map[s] || 'new';
};

function StatusBadge({ s }) {
  const norm = normalizeStatus(s);
  const m = { new:'badge-new', confirmed:'badge-production', ready:'badge-ready', delivered:'badge-delivered', cancelled:'badge-delivered' };
  const l = { new:'Nieuw', confirmed:'Bevestigd', ready:'Klaar', delivered:'Geleverd', cancelled:'Geannuleerd' };
  return <span className={`badge ${m[norm]||'badge-new'}`}>{l[norm]||s}</span>;
}

// Empty B2B order form state
function emptyB2bOrder() {
  return {
    customer_name: '', phone: '', email: '',
    delivery_date: new Date(Date.now()+86400000).toISOString().split('T')[0],
    note: '', status: 'new', customer_type: 'b2b', source: 'manual',
    items: [{ pid: 'spelt-groot', qty: 1 }],
  };
}

// â”€â”€â”€ BestellingenPage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BestellingenPage({ orders, setOrders, products: PRODUCTS }) {
  PRODUCTS = PRODUCTS || DEFAULT_PRODUCTS;
  const [loading, setLoading]       = useState(false);
  const [error, setError]           = useState(null);
  const [selected, setSelected]     = useState(null);
  const [search, setSearch]         = useState('');
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterType, setFilterType]   = useState('all');
  const [showB2bForm, setShowB2bForm] = useState(false);
  const [b2bForm, setB2bForm]         = useState(emptyB2bOrder());
  const [saving, setSaving]           = useState(false);

  async function loadOrders() {
    setLoading(true); setError(null);
    try {
      const data = await apiGet('/orders');
      const apiOrders = (data.orders || data || []).map(o => ({ ...o, source: 'takeapp' }));
      // Merge: keep manual B2B orders, replace Take App ones
      setOrders(prev => {
        const manual = prev.filter(o => o.source === 'manual');
        return [...apiOrders, ...manual];
      });
    } catch (e) {
      setError(e.message);
    } finally { setLoading(false); }
  }

  useEffect(() => {
    loadOrders();
    const interval = setInterval(loadOrders, 15 * 60 * 1000);
    return () => clearInterval(interval);
  }, []);

  async function updateStatus(orderId, status) {
    // For manual orders, just update locally
    setOrders(prev => prev.map(o => o.id === orderId ? { ...o, status } : o));
    if (selected?.id === orderId) setSelected(s => ({ ...s, status }));
    // Also try API for Take App orders
    const order = orders.find(o => o.id === orderId);
    if (order?.source === 'takeapp') {
      try { await apiPut(`/orders/${orderId}`, { status }); } catch (_) {}
    }
  }

  // Compute totals from items for B2B form
  function calcB2bTotal(items) {
    return items.reduce((sum, item) => {
      const prod = PRODUCTS[item.pid];
      if (!prod) return sum;
      return sum + (prod.price_b2b || prod.price_b2c || 0) * item.qty;
    }, 0);
  }

  function addB2bItem() { setB2bForm(f => ({ ...f, items: [...f.items, { pid: 'spelt-groot', qty: 1 }] })); }
  function removeB2bItem(i) { setB2bForm(f => ({ ...f, items: f.items.filter((_, j) => j !== i) })); }
  function updateB2bItem(i, field, val) {
    setB2bForm(f => { const items = [...f.items]; items[i] = { ...items[i], [field]: val }; return { ...f, items }; });
  }

  function saveB2bOrder() {
    setSaving(true);
    const total = calcB2bTotal(b2bForm.items);
    const newOrder = {
      ...b2bForm,
      id: 'B2B-' + Date.now(),
      total,
      items: b2bForm.items.map(item => ({
        pid: item.pid,
        name: PRODUCTS[item.pid]?.name || item.pid,
        quantity: item.qty,
        qty: item.qty,
        price: PRODUCTS[item.pid]?.price_b2b || 0,
      })),
    };
    setOrders(prev => [newOrder, ...prev]);
    setShowB2bForm(false);
    setB2bForm(emptyB2bOrder());
    setSaving(false);
  }

  function deleteManualOrder(id) {
    if (!confirm('Bestelling verwijderen?')) return;
    setOrders(prev => prev.filter(o => o.id !== id));
    setSelected(null);
  }

  const filtered = orders.filter(o => {
    const name = getCustomer(o).toLowerCase();
    const matchQ = !search || name.includes(search.toLowerCase());
    const matchS = filterStatus === 'all' || normalizeStatus(o.status) === filterStatus;
    const matchT = filterType   === 'all' || getType(o) === filterType;
    return matchQ && matchS && matchT;
  });

  const newCount = orders.filter(o => normalizeStatus(o.status) === 'new').length;
  const b2bRevenue = orders.filter(o => getType(o)==='b2b').reduce((s,o) => s+getTotal(o), 0);
  const b2cRevenue = orders.filter(o => getType(o)==='b2c').reduce((s,o) => s+getTotal(o), 0);

  // Input style helper
  const inp = (extra={}) => ({ padding:'8px 12px', border:'1px solid var(--border)', borderRadius:'8px', fontSize:'13px', fontFamily:'DM Sans, sans-serif', background:'var(--cream)', color:'var(--dark)', outline:'none', width:'100%', ...extra });

  return <div className="page-enter">
    <div className="page-header">
      <h2>Bestellingen</h2>
      <p>{orders.length} bestellingen Â· {fmt(b2bRevenue + b2cRevenue)} totale omzet</p>
    </div>

    {/* Stats */}
    <div className="stats-grid" style={{ marginBottom:'20px' }}>
      {[
        { label:'Nieuw', value: newCount, sub:'te verwerken', color:'#1D4ED8' },
        { label:'B2C omzet', value: fmt(b2cRevenue), sub:`${orders.filter(o=>getType(o)==='b2c').length} orders` },
        { label:'B2B omzet', value: fmt(b2bRevenue), sub:`${orders.filter(o=>getType(o)==='b2b').length} orders` },
        { label:'Totaal', value: orders.length, sub:'bestellingen' },
      ].map((s,i) => <div key={i} className="stat-card">
        <div className="label">{s.label}</div>
        <div className="value" style={{ fontSize: typeof s.value==='string'?'22px':'36px', color: s.color||'var(--dark)' }}>{s.value}</div>
        <div className="sub">{s.sub}</div>
      </div>)}
    </div>

    {/* Toolbar */}
    <div className="toolbar">
      <input className="search-input" placeholder="Zoek klantâ€¦" value={search} onChange={e=>setSearch(e.target.value)} />
      <select className="select-input" value={filterStatus} onChange={e=>setFilterStatus(e.target.value)}>
        <option value="all">Alle statussen</option>
        <option value="new">Nieuw</option>
        <option value="confirmed">Bevestigd</option>
        <option value="ready">Klaar</option>
        <option value="delivered">Geleverd</option>
        <option value="cancelled">Geannuleerd</option>
      </select>
      <select className="select-input" value={filterType} onChange={e=>setFilterType(e.target.value)}>
        <option value="all">B2B + B2C</option>
        <option value="b2b">Alleen B2B</option>
        <option value="b2c">Alleen B2C</option>
      </select>
      <div className="toolbar-spacer" />
      {loading
        ? <div style={{ display:'flex', alignItems:'center', gap:'6px', fontSize:'11px', fontFamily:'DM Mono', color:'var(--text-muted)' }}>
            <div className="spinner" style={{ width:14, height:14, margin:0, border:'2px solid var(--border)', borderTopColor:'var(--amber)' }} />
            syncingâ€¦
          </div>
        : <div style={{ fontSize:'10px', fontFamily:'DM Mono', color:'var(--text-muted)' }}>â†» elke 15 min</div>
      }
      <button className="btn btn-primary" onClick={()=>setShowB2bForm(true)}>+ B2B bestelling</button>
    </div>

    {error && <div className="error-msg" style={{marginBottom:'16px'}}>âš ï¸ Take App: {error}</div>}

    {/* Orders list */}
    <div className="orders-grid">
      {filtered.length===0 && <div className="empty-msg"><div className="icon">ğŸ“­</div>Geen bestellingen gevonden</div>}
      {filtered.map(o => <div key={o.id} className={`order-card ${selected?.id===o.id?'selected':''}`} onClick={()=>setSelected(o)}>
        <div className="order-num" style={{ display:'flex', flexDirection:'column', gap:'3px' }}>
          <span style={{ fontFamily:'DM Mono', fontSize:'11px', color:'var(--text-muted)' }}>#{o.number || String(o.id).slice(-5)}</span>
          {o.source==='manual' && <span style={{ fontSize:'9px', background:'#F3E8FF', color:'#6B21A8', padding:'1px 5px', borderRadius:'4px', fontFamily:'DM Mono' }}>manueel</span>}
        </div>
        <div className="order-customer">
          <strong>{getCustomer(o)}</strong>
          <span>{o.deliveryDate||o.delivery_date||o.date||(o.createdAt ? new Date(o.createdAt).toLocaleDateString('nl-BE') : 'â€”')}</span>
        </div>
        <div className="order-items" style={{ fontSize:'12px', color:'var(--text-muted)' }}>{getItems(o)||'â€”'}</div>
        <span className={`badge badge-${getType(o)}`}>{getType(o).toUpperCase()}</span>
        <StatusBadge s={o.status||'new'} />
        <div className="order-total">{fmt(getTotal(o))}</div>
      </div>)}
    </div>

    {/* Order detail modal */}
    {selected && <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&setSelected(null)}>
      <div className="modal">
        <div style={{ display:'flex', alignItems:'flex-start', gap:'12px', marginBottom:'4px' }}>
          <div style={{ flex:1 }}>
            <h3 style={{ marginBottom:'6px' }}>{getCustomer(selected)}</h3>
            <div style={{ display:'flex', gap:'6px', flexWrap:'wrap' }}>
              <StatusBadge s={selected.status||'new'} />
              <span className={`badge badge-${getType(selected)}`}>{getType(selected).toUpperCase()}</span>
              {selected.source==='manual'&&<span className="badge" style={{background:'#F3E8FF',color:'#6B21A8',border:'1px solid #DDD6FE'}}>Manueel</span>}
            </div>
          </div>
          <button onClick={()=>setSelected(null)} style={{ border:'none', background:'none', fontSize:'20px', cursor:'pointer', color:'var(--text-muted)' }}>âœ•</button>
          {selected.paymentStatus && <span className="badge" style={{ background: selected.paymentStatus==='PAYMENT_STATUS_PAID'?'#D1FAE5':'#FEF3C7', color: selected.paymentStatus==='PAYMENT_STATUS_PAID'?'#065F46':'#92400E', border:'none', fontSize:'10px' }}>
            {selected.paymentStatus==='PAYMENT_STATUS_PAID'?'âœ“ Betaald':selected.paymentStatus==='PAYMENT_STATUS_PENDING'?'â³ Onbetaald':'ğŸ’³ '+selected.paymentStatus.replace('PAYMENT_STATUS_','')}
          </span>}
        </div>

        {(selected.customer?.phone||selected.customerPhone||selected.phone) && <div style={{ fontSize:'12px', color:'var(--text-muted)', marginTop:'6px' }}>ğŸ“ {selected.customer?.phone||selected.customerPhone||selected.phone}</div>}
        {(selected.customer?.email||selected.customerEmail||selected.email) && <div style={{ fontSize:'12px', color:'var(--text-muted)' }}>âœ‰ï¸ {selected.customer?.email||selected.customerEmail||selected.email}</div>}
        <div style={{ fontSize:'12px', color:'var(--text-muted)' }}>ğŸ“… {selected.deliveryDate||selected.delivery_date ? 'Levering: '+(selected.deliveryDate||selected.delivery_date) : 'Besteld op: '+new Date(selected.createdAt||Date.now()).toLocaleDateString('nl-BE')}</div>

        <div className="divider" />

        {(selected.items||selected.order_items||[]).map((item,i) => {
          const pid = item.pid || matchProduct(item.name||item.product_name);
          const prod = pid ? PRODUCTS[pid] : null;
          const rawPrice = item.price||item.unit_price||0;
          const price = rawPrice > 100 && Number.isInteger(rawPrice) ? rawPrice / 100 : rawPrice;
          const qty = item.quantity||item.qty||1;
          return <div key={i} className="order-detail-item">
            <span>{qty}Ã— {item.name||item.product_name||'?'}</span>
            <div style={{ display:'flex', gap:'10px', alignItems:'center' }}>
              {prod && <span className="profit-pill profit-high">{Math.round((prod.price_b2c - prod.flour_kg*prod.flour_cost_kg)/prod.price_b2c*100)}% marge</span>}
              <span style={{ fontFamily:'DM Mono', fontSize:'13px' }}>{fmt(price*qty)}</span>
            </div>
          </div>;
        })}

        <div className="divider" />
        <div style={{ display:'flex', justifyContent:'space-between', fontFamily:'DM Serif Display', fontSize:'22px' }}>
          <span>Totaal</span><span style={{ color:'var(--amber)' }}>{fmt(getTotal(selected))}</span>
        </div>

        {(selected.note || selected.remark) && <div style={{ marginTop:'12px', background:'var(--flour)', borderRadius:'8px', padding:'10px 14px', fontSize:'13px', color:'var(--text-muted)' }}>ğŸ“ {selected.note || selected.remark}</div>}

        <div className="modal-footer">
          <div style={{ flex:1 }}>
            <label style={{ fontSize:'11px', fontFamily:'DM Mono', color:'var(--text-muted)', display:'block', marginBottom:'4px' }}>STATUS</label>
            <select className="status-select" value={normalizeStatus(selected.status)} onChange={e=>updateStatus(selected.id, e.target.value)}>
              <option value="new">Nieuw</option>
              <option value="confirmed">Bevestigd</option>
              <option value="ready">Klaar</option>
              <option value="delivered">Geleverd</option>
              <option value="cancelled">Geannuleerd</option>
            </select>
          </div>
          {selected.source==='manual' && <button className="btn btn-danger" onClick={()=>deleteManualOrder(selected.id)}>Verwijderen</button>}
          <button className="btn btn-secondary" onClick={()=>setSelected(null)}>Sluiten</button>
        </div>
      </div>
    </div>}

    {/* B2B form modal */}
    {showB2bForm && <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&setShowB2bForm(false)}>
      <div className="modal" style={{ width:'580px' }}>
        <h3>Nieuwe B2B bestelling</h3>

        {/* Customer info */}
        <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:'10px', marginBottom:'16px' }}>
          {[
            ['Klantnaam *','customer_name','text','bv. Bakkerij De Molen'],
            ['Telefoon','phone','tel','bv. 0478 12 34 56'],
            ['E-mail','email','email','bv. info@bakkerij.be'],
            ['Leveringsdatum *','delivery_date','date',''],
          ].map(([label,field,type,placeholder]) => <div key={field}>
            <div style={{ fontSize:'11px', fontFamily:'DM Mono', color:'var(--text-muted)', textTransform:'uppercase', letterSpacing:'0.08em', marginBottom:'4px' }}>{label}</div>
            <input type={type} value={b2bForm[field]} placeholder={placeholder}
              onChange={e=>setB2bForm(f=>({...f,[field]:e.target.value}))}
              style={inp()} />
          </div>)}
        </div>

        {/* Items */}
        <div style={{ fontSize:'11px', fontFamily:'DM Mono', color:'var(--text-muted)', textTransform:'uppercase', letterSpacing:'0.08em', marginBottom:'8px' }}>Producten</div>

        <div style={{ display:'grid', gridTemplateColumns:'1fr 80px 80px 28px', gap:'8px', marginBottom:'6px', padding:'0 4px' }}>
          {['Product','Aantal','B2B prijs',''].map(h=><div key={h} style={{ fontSize:'10px', fontFamily:'DM Mono', color:'var(--text-muted)', textTransform:'uppercase' }}>{h}</div>)}
        </div>

        {b2bForm.items.map((item, i) => {
          const prod = PRODUCTS[item.pid];
          return <div key={i} style={{ display:'grid', gridTemplateColumns:'1fr 80px 80px 28px', gap:'8px', marginBottom:'6px', alignItems:'center' }}>
            <select value={item.pid} onChange={e=>updateB2bItem(i,'pid',e.target.value)} style={inp()}>
              {Object.entries(PRODUCTS).filter(([,p])=>p.price_b2b).map(([pid,p])=>
                <option key={pid} value={pid}>{p.name}</option>)}
            </select>
            <input type="number" min="1" value={item.qty} onChange={e=>updateB2bItem(i,'qty',parseInt(e.target.value)||1)} style={inp({ textAlign:'center' })} />
            <div style={{ fontFamily:'DM Mono', fontSize:'13px', padding:'8px 0', color:'var(--amber)' }}>{fmt((prod?.price_b2b||0)*item.qty)}</div>
            <button onClick={()=>removeB2bItem(i)} style={{ border:'none', background:'none', cursor:'pointer', color:'#DC2626', fontSize:'16px' }}>âœ•</button>
          </div>;
        })}

        <button className="wf-add-btn" onClick={addB2bItem}>+ Product toevoegen</button>

        <div style={{ marginTop:'12px' }}>
          <div style={{ fontSize:'11px', fontFamily:'DM Mono', color:'var(--text-muted)', textTransform:'uppercase', letterSpacing:'0.08em', marginBottom:'4px' }}>Opmerking</div>
          <textarea value={b2bForm.note} onChange={e=>setB2bForm(f=>({...f,note:e.target.value}))} rows={2}
            style={{ ...inp(), resize:'vertical' }} placeholder="Speciale wensen, afleverinstructiesâ€¦" />
        </div>

        <div style={{ background:'var(--flour)', borderRadius:'8px', padding:'12px 16px', marginTop:'12px', display:'flex', justifyContent:'space-between', alignItems:'center' }}>
          <span style={{ fontSize:'13px', color:'var(--text-muted)' }}>Totaal ({b2bForm.items.reduce((s,i)=>s+i.qty,0)} broden)</span>
          <span style={{ fontFamily:'DM Serif Display', fontSize:'22px', color:'var(--amber)' }}>{fmt(calcB2bTotal(b2bForm.items))}</span>
        </div>

        <div className="modal-footer">
          <button className="btn btn-secondary" onClick={()=>setShowB2bForm(false)}>Annuleren</button>
          <button className="btn btn-primary" onClick={saveB2bOrder} disabled={!b2bForm.customer_name||saving}>
            {saving ? 'Opslaanâ€¦' : 'âœ“ Bestelling opslaan'}
          </button>
        </div>
      </div>
    </div>}
  </div>;
}

// Production plan
function ProductionPage({ orders, products: PRODUCTS }) {
  PRODUCTS = PRODUCTS || DEFAULT_PRODUCTS;
  const [plan, setPlan] = useState([]);
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

  useEffect(() => { buildPlan(); }, [orders, date]);

  function buildPlan() {
    // Aggregate items from orders for the selected date
    const counts = {};
    (orders || []).forEach(o => {
      const oDate = o.delivery_date || o.date || '';
      if (date && !oDate.startsWith(date)) return;
      (o.items || o.order_items || []).forEach(item => {
        const pid = matchProduct(item.name || item.product_name);
        if (!pid) return;
        counts[pid] = (counts[pid] || 0) + (item.quantity || item.qty || 1);
      });
    });

    // Group into sessions
    const sessions = [];
    Object.entries(counts).forEach(([pid, qty]) => {
      const prod = PRODUCTS[pid];
      if (!prod) return;
      const numSessions = Math.ceil(qty / prod.per_session);
      for (let s = 0; s < numSessions; s++) {
        const batchQty = s < numSessions - 1 ? prod.per_session : qty - s * prod.per_session;
        const flourNeeded = batchQty * prod.flour_kg;
        sessions.push({ pid, prod, qty: batchQty, flour: flourNeeded, session: s + 1, total_sessions: numSessions });
      }
    });

    // Group by flour type
    const grouped = {};
    sessions.forEach(s => {
      const g = s.prod.category;
      if (!grouped[g]) grouped[g] = [];
      grouped[g].push(s);
    });
    setPlan(Object.entries(grouped).map(([cat, items]) => ({ cat, items })));
  }

  // Also show full totals
  const totalFlour = {};
  plan.forEach(g => g.items.forEach(i => {
    totalFlour[i.prod.flour_type] = (totalFlour[i.prod.flour_type] || 0) + i.flour;
  }));

  const flourNames = { spelt: 'Speltmeel', spelt_energy: 'Spelt Energy', wit: 'Witte bloem', bruin: 'Bruine bloem', rogge: 'Roggemeel' };

  return <div className="page-enter">
    <div className="page-header">
      <h2>Productieplanning</h2>
      <p>Bakschema gebaseerd op bestellingen</p>
    </div>
    <div className="toolbar">
      <label style={{ fontSize: '12px', fontFamily: 'DM Mono', color: 'var(--text-muted)' }}>BAKDATUM</label>
      <input type="date" className="search-input" value={date} onChange={e => setDate(e.target.value)} style={{ width: '160px' }} />
      <div className="toolbar-spacer" />
      <button className="btn btn-primary" onClick={() => window.print()}>ğŸ–¨ï¸ Afdrukken</button>
    </div>

    {plan.length === 0 && <div className="empty-msg"><div className="icon">ğŸ</div>Geen bestellingen voor deze datum.<br />Selecteer een andere datum of laad bestellingen opnieuw.</div>}

    {plan.map(({ cat, items }) => <div key={cat} className="bake-session">
      <div className="bake-session-header">
        <h3>{cat}</h3>
        <span style={{ fontSize: '13px', color: 'var(--text-muted)' }}>{items.length} baksessie(s)</span>
      </div>
      <div className="bake-session-body">
        {items.map((item, i) => <div key={i} className="bake-row">
          <div className="bake-product">{item.prod.name} {item.total_sessions > 1 && `(sessie ${item.session}/${item.total_sessions})`}</div>
          <div className="bake-qty">{item.qty} stuks</div>
          <div className="bake-flour">ğŸŒ¾ {item.flour.toFixed(2)} kg {flourNames[item.prod.flour_type] || item.prod.flour_type}</div>
          <div style={{ fontFamily: 'DM Mono', fontSize: '12px', color: 'var(--text-muted)' }}>â± {item.prod.session_min} min</div>
        </div>)}
      </div>
    </div>)}

    {Object.keys(totalFlour).length > 0 && <div className="card" style={{ marginTop: '16px' }}>
      <h3 style={{ fontFamily: 'DM Serif Display', fontSize: '18px', marginBottom: '16px' }}>Totaal bloem nodig</h3>
      {Object.entries(totalFlour).map(([type, kg]) => <div key={type} className="bake-row">
        <div className="bake-product">{flourNames[type] || type}</div>
        <div style={{ fontFamily: 'DM Mono', fontWeight: 500 }}>{kg.toFixed(2)} kg</div>
      </div>)}
    </div>}
  </div>;
}

// Timers page
function TimersPage() {
  const [timers, setTimers] = useState([]);
  const intervalRef = useRef(null);

  useEffect(() => {
    intervalRef.current = setInterval(() => {
      setTimers(prev => prev.map(t => {
        if (!t.running || t.remaining <= 0) return t;
        const remaining = Math.max(0, t.remaining - 1);
        if (remaining === 0 && t.running) {
          // Play notification sound conceptually; show alert
          setTimeout(() => alert(`â° Timer klaar: ${t.label}!`), 100);
        }
        return { ...t, remaining, running: remaining > 0 };
      }));
    }, 1000);
    return () => clearInterval(intervalRef.current);
  }, []);

  function addTimer(preset) {
    setTimers(prev => [...prev, {
      id: Date.now(),
      label: preset.label,
      phase: preset.phase,
      total: preset.duration_min * 60,
      remaining: preset.duration_min * 60,
      running: false,
      color: preset.color,
    }]);
  }

  function toggle(id) { setTimers(prev => prev.map(t => t.id === id ? { ...t, running: !t.running } : t)); }
  function reset(id) { setTimers(prev => prev.map(t => t.id === id ? { ...t, remaining: t.total, running: false } : t)); }
  function remove(id) { setTimers(prev => prev.filter(t => t.id !== id)); }

  return <div className="page-enter">
    <div className="page-header">
      <h2>Fermentatie Timers</h2>
      <p>Beheer al je rijs- en baktijden</p>
    </div>

    <div className="card" style={{ marginBottom: '24px' }}>
      <h3 style={{ fontFamily: 'DM Serif Display', fontSize: '18px', marginBottom: '16px' }}>Voeg timer toe</h3>
      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
        {TIMER_PRESETS.map(p => <button key={p.id} className="btn btn-secondary" onClick={() => addTimer(p)}>
          + {p.label} ({p.duration_min >= 60 ? p.duration_min / 60 + 'u' : p.duration_min + 'min'})
        </button>)}
      </div>
    </div>

    {timers.length === 0 && <div className="empty-msg"><div className="icon">â±ï¸</div>Nog geen timers. Voeg er een toe hierboven.</div>}

    <div className="timers-grid">
      {timers.map(t => {
        const pct = t.total > 0 ? ((t.total - t.remaining) / t.total) * 100 : 0;
        const done = t.remaining === 0;
        return <div key={t.id} className={`timer-card ${t.running ? 'running' : ''} ${done ? 'done' : ''}`}>
          <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '4px', background: done ? 'var(--sage)' : t.color, opacity: t.running ? 1 : 0.4 }} />
          <h3>{t.label}</h3>
          <div className="phase">{t.phase}</div>
          <div className={`timer-display ${t.running ? 'running' : ''} ${done ? 'done' : ''}`}>
            {done ? 'âœ“ Klaar' : fmtTime(t.remaining)}
          </div>
          <div className="timer-progress">
            <div className={`timer-progress-fill ${done ? 'done' : ''}`} style={{ width: pct + '%', background: done ? 'var(--sage)' : t.color }} />
          </div>
          <div className="timer-btns">
            {!done && <button className="btn btn-primary" style={{ background: t.color }} onClick={() => toggle(t.id)}>
              {t.running ? 'â¸' : 'â–¶'} {t.running ? 'Pauzeer' : 'Start'}
            </button>}
            <button className="btn btn-secondary" onClick={() => reset(t.id)}>â†º</button>
            <button className="btn btn-danger" onClick={() => remove(t.id)}>âœ•</button>
          </div>
        </div>;
      })}
    </div>
  </div>;
}

// Inventory page
function InventoryPage({ ingredients, setIngredients }) {
  const [stock, setStock] = useState((ingredients || DEFAULT_INVENTORY).map(i => ({ ...i })));
  const [editing, setEditing] = useState(null);
  const [editVal, setEditVal] = useState('');

  function startEdit(id, val) { setEditing(id); setEditVal(String(val)); }
  function saveEdit(id) {
    const val = parseFloat(editVal);
    if (!isNaN(val)) setStock(s => { const ns = s.map(i => i.id === id ? { ...i, stock_kg: val } : i); if (setIngredients) setIngredients(ns); return ns; });
    setEditing(null);
  }

  const lowItems = stock.filter(i => i.stock_kg < i.min_stock);

  return <div className="page-enter">
    <div className="page-header">
      <h2>IngrediÃ«nten & Voorraad</h2>
      <p>Klik op een voorraad om te wijzigen</p>
    </div>

    {lowItems.length > 0 && <div className="error-msg" style={{ marginBottom: '20px', background: '#FEF3C7', borderColor: '#FDE68A', color: '#92400E' }}>
      âš ï¸ Lage voorraad: {lowItems.map(i => i.name).join(', ')}
    </div>}

    <div className="inventory-grid">
      {stock.map(item => {
        const pct = Math.min(100, (item.stock_kg / (item.min_stock * 3)) * 100);
        const low = item.stock_kg < item.min_stock;
        return <div key={item.id} className={`ingredient-card ${low ? 'low' : ''}`}>
          <div className="name">{item.name}</div>
          {editing === item.id ? (
            <div style={{ display: 'flex', gap: '8px', marginTop: '8px', alignItems: 'center' }}>
              <input autoFocus type="number" value={editVal} onChange={e => setEditVal(e.target.value)}
                onKeyDown={e => { if (e.key === 'Enter') saveEdit(item.id); if (e.key === 'Escape') setEditing(null); }}
                style={{ width: '80px', padding: '4px 8px', border: '1px solid var(--amber)', borderRadius: '6px', fontFamily: 'DM Mono' }} />
              <button className="btn btn-primary" style={{ padding: '4px 10px' }} onClick={() => saveEdit(item.id)}>âœ“</button>
            </div>
          ) : (
            <div className={`stock ${low ? 'low' : ''}`} onClick={() => startEdit(item.id, item.stock_kg)} style={{ cursor: 'pointer' }} title="Klik om te wijzigen">
              {item.stock_kg} <span className="unit">{item.unit}</span>
            </div>
          )}
          <div className="stock-bar">
            <div className="stock-bar-fill" style={{ width: pct + '%', background: low ? '#DC2626' : pct > 60 ? 'var(--sage)' : 'var(--amber)' }} />
          </div>
          <div className="cost">Min: {item.min_stock} {item.unit} Â· {item.cost_kg > 0 ? `â‚¬${item.cost_kg}/${item.unit}` : 'Gratis'}</div>
        </div>;
      })}
    </div>
  </div>;
}

// Labels page
function LabelsPage({ products: PRODUCTS }) {
  PRODUCTS = PRODUCTS || DEFAULT_PRODUCTS;
  const [selected, setSelected] = useState([]);
  const [qty, setQty] = useState({});

  function toggle(pid) {
    setSelected(s => s.includes(pid) ? s.filter(x => x !== pid) : [...s, pid]);
    if (!qty[pid]) setQty(q => ({ ...q, [pid]: 1 }));
  }

  function printLabels() {
    const labelsHtml = selected.flatMap(pid => {
      const prod = PRODUCTS[pid];
      const n = qty[pid] || 1;
      return Array(n).fill(0).map((_, i) => `
        <div style="display:inline-block;width:240px;height:140px;border:2px solid #1A1410;border-radius:8px;padding:16px;margin:8px;font-family:serif;position:relative;overflow:hidden;vertical-align:top;page-break-inside:avoid;">
          <div style="position:absolute;top:0;left:0;right:0;height:6px;background:#C8840A;"></div>
          <div style="font-size:9px;letter-spacing:0.15em;text-transform:uppercase;color:#8B7355;margin-top:8px;">Zuurdesem Bakkerij</div>
          <div style="font-size:20px;font-weight:bold;margin-top:2px;">${prod.name}</div>
          <div style="font-size:11px;color:#8B7355;">${prod.weight_g ? prod.weight_g + 'g' : ''} Â· Artisanaal zuurdesem</div>
          <div style="font-size:24px;font-weight:bold;color:#C8840A;position:absolute;bottom:12px;right:16px;">â‚¬${prod.price_b2c?.toFixed(2)}</div>
          <div style="font-size:9px;color:#8B7355;position:absolute;bottom:12px;left:16px;">BTW incl. 6%</div>
        </div>`);
    }).join('');
    const w = window.open('', '_blank');
    w.document.write(`<html><body style="background:white;padding:16px;">${labelsHtml}</body></html>`);
    w.document.close();
    w.print();
  }

  return <div className="page-enter">
    <div className="page-header">
      <h2>Etiketten & Bonnen</h2>
      <p>Selecteer producten en druk etiketten af</p>
    </div>
    <div className="toolbar">
      <div className="toolbar-spacer" />
      {selected.length > 0 && <button className="btn btn-primary" onClick={printLabels}>ğŸ–¨ï¸ Druk {selected.reduce((a,p)=>a+(qty[p]||1),0)} etiketten af</button>}
    </div>

    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0' }}>
      {Object.entries(PRODUCTS).map(([pid, prod]) => {
        const sel = selected.includes(pid);
        return <div key={pid} style={{ position: 'relative', display: 'inline-block' }} onClick={() => toggle(pid)}>
          <div className="label-preview" style={sel ? { border: '2px solid var(--amber)', boxShadow: '0 0 0 3px rgba(200,132,10,0.2)' } : {}}>
            <div className="bakery-name">Zuurdesem Bakkerij</div>
            <h4>{prod.name}</h4>
            <div className="weight">{prod.weight_g ? prod.weight_g + 'g Â·' : ''} {prod.category}</div>
            <div className="price">{prod.price_b2c ? `â‚¬${prod.price_b2c.toFixed(2)}` : 'B2B'}</div>
            {sel && <div style={{ position: 'absolute', top: '10px', right: '10px', background: 'var(--amber)', color: 'white', borderRadius: '50%', width: '20px', height: '20px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: 'bold' }}>âœ“</div>}
          </div>
          {sel && <div style={{ textAlign: 'center', marginTop: '-4px', marginBottom: '4px' }} onClick={e => e.stopPropagation()}>
            <input type="number" min="1" max="100" value={qty[pid] || 1} onChange={e => setQty(q => ({ ...q, [pid]: parseInt(e.target.value) || 1 }))}
              style={{ width: '60px', textAlign: 'center', border: '1px solid var(--border)', borderRadius: '6px', padding: '2px 6px', fontFamily: 'DM Mono' }} />
            <span style={{ fontSize: '11px', color: 'var(--text-muted)', marginLeft: '4px' }}>stuks</span>
          </div>}
        </div>;
      })}
    </div>
  </div>;
}

// â”€â”€â”€ Default workflows per product â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each step: { id, type, label, duration_min, day (0=T-2,1=T-1,2=T0), min_after, max_after }
const DEFAULT_WORKFLOWS = {
  'spelt-groot': [
    { id: 1, type: 'kneden',  label: 'Kneden',           duration_min: 20, day: 0, min_after: null, max_after: null },
    { id: 2, type: 'vouwen',  label: 'Vouwen (1)',        duration_min: 5,  day: 0, min_after: 30,  max_after: 60  },
    { id: 3, type: 'vouwen',  label: 'Vouwen (2)',        duration_min: 5,  day: 0, min_after: 30,  max_after: 60  },
    { id: 4, type: 'vouwen',  label: 'Vouwen (3)',        duration_min: 5,  day: 0, min_after: 30,  max_after: 60  },
    { id: 5, type: 'rijzen',  label: 'Bulk rijs',         duration_min: 0,  day: 0, min_after: 120, max_after: 240 },
    { id: 6, type: 'rijzen',  label: 'Koelkast rijs',     duration_min: 0,  day: 0, min_after: 30,  max_after: 90  },
    { id: 7, type: 'bakken',  label: 'Bakken',            duration_min: 50, day: 2, min_after: 720, max_after: 960 },
  ],
  'rogge': [
    { id: 1, type: 'kneden',  label: 'Kneden',            duration_min: 15, day: 0, min_after: null, max_after: null },
    { id: 2, type: 'rijzen',  label: 'Bulk rijs',         duration_min: 0,  day: 0, min_after: 180, max_after: 300 },
    { id: 3, type: 'rijzen',  label: 'Koelkast rijs',     duration_min: 0,  day: 0, min_after: 30,  max_after: 60  },
    { id: 4, type: 'bakken',  label: 'Bakken',            duration_min: 60, day: 2, min_after: 600, max_after: 960 },
  ],
};
// Fallback: copy spelt workflow for similar products
['spelt-energy-groot','wit-groot','bruin-groot','spelt-klein','spelt-energy-klein','wit-klein','bruin-klein','vijg-noot'].forEach(pid => {
  if (!DEFAULT_WORKFLOWS[pid]) DEFAULT_WORKFLOWS[pid] = DEFAULT_WORKFLOWS['spelt-groot'].map(s => ({ ...s }));
});
DEFAULT_WORKFLOWS['pistolet'] = [
  { id: 1, type: 'kneden', label: 'Kneden',       duration_min: 15, day: 1, min_after: null, max_after: null },
  { id: 2, type: 'rijzen', label: 'Eerste rijs',  duration_min: 0,  day: 1, min_after: 60,  max_after: 120 },
  { id: 3, type: 'vouwen', label: 'Opbollen',     duration_min: 10, day: 1, min_after: 5,   max_after: 30  },
  { id: 4, type: 'rijzen', label: 'Tweede rijs',  duration_min: 0,  day: 2, min_after: 60,  max_after: 90  },
  { id: 5, type: 'bakken', label: 'Bakken',       duration_min: 35, day: 2, min_after: 5,   max_after: 30  },
];
DEFAULT_WORKFLOWS['kaneelkoek'] = [
  { id: 1, type: 'kneden', label: 'Deeg maken',   duration_min: 20, day: 1, min_after: null, max_after: null },
  { id: 2, type: 'rijzen', label: 'Rijs',         duration_min: 0,  day: 1, min_after: 120, max_after: 180 },
  { id: 3, type: 'vouwen', label: 'Oprollen',     duration_min: 15, day: 1, min_after: 5,   max_after: 30  },
  { id: 4, type: 'rijzen', label: 'Koelkast',     duration_min: 0,  day: 1, min_after: 30,  max_after: 60  },
  { id: 5, type: 'bakken', label: 'Bakken',       duration_min: 15, day: 2, min_after: 420, max_after: 720 },
];

const STEP_TYPES = ['kneden', 'vouwen', 'rijzen', 'bakken'];
const DAY_LABELS = ['T-2', 'T-1', 'T0'];

// â”€â”€â”€ WorkflowPage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function WorkflowPage({ workflows, setWorkflows, productLinks, setProductLinks, products: PRODUCTS }) {
  PRODUCTS = PRODUCTS || DEFAULT_PRODUCTS;
  const [activePid, setActivePid]     = useState(null);
  const [inventory, setInventory]     = useState([]);
  const [invLoading, setInvLoading]   = useState(false);
  const [invError, setInvError]       = useState(null);

  // Load inventory from Take App
  async function loadInventory() {
    setInvLoading(true); setInvError(null);
    try {
      const data = await apiGet('/inventory');
      setInventory(data.products || data.inventory || data || []);
    } catch (e) {
      setInvError(e.message);
      // Mock fallback
      setInventory(MOCK_INVENTORY);
    } finally { setInvLoading(false); }
  }

  useEffect(() => { loadInventory(); }, []);

  const steps = activePid ? (workflows[activePid] || DEFAULT_WORKFLOWS[activePid] || []) : [];

  function save(newSteps) { setWorkflows(w => ({ ...w, [activePid]: newSteps })); }
  function addStep() {
    const maxId = steps.reduce((m,s) => Math.max(m,s.id), 0);
    save([...steps, { id:maxId+1, type:'rijzen', label:'Nieuwe stap', duration_min:30, day:0, min_after:60, max_after:120 }]);
  }
  function updateStep(id, field, value) { save(steps.map(s => s.id===id ? {...s,[field]:value} : s)); }
  function removeStep(id)               { save(steps.filter(s => s.id!==id)); }
  function moveStep(id, dir) {
    const idx = steps.findIndex(s => s.id===id);
    const ns = [...steps]; const si = idx+dir;
    if (si<0||si>=ns.length) return;
    [ns[idx],ns[si]] = [ns[si],ns[idx]]; save(ns);
  }

  return <div className="page-enter">
    <div className="page-header">
      <h2>Bakinstructies</h2>
      <p>Koppel Take App producten aan een bakworkflow</p>
    </div>

    {/* â”€â”€ Inventory from Take App â”€â”€ */}
    <div style={{ marginBottom:'28px' }}>
      <div style={{ display:'flex', alignItems:'center', gap:'12px', marginBottom:'14px' }}>
        <h3 style={{ fontFamily:'DM Serif Display', fontSize:'20px', flex:1 }}>Take App producten</h3>
        <button className="btn btn-secondary" onClick={loadInventory} disabled={invLoading}>
          {invLoading ? 'â€¦' : 'â†» Vernieuwen'}
        </button>
      </div>

      {invError && <div className="error-msg" style={{marginBottom:'12px'}}>âš ï¸ {invError} â€” demo getoond</div>}

      <div style={{ display:'flex', flexDirection:'column', gap:'8px' }}>
        {(invLoading && inventory.length===0) && <div className="spinner" />}
        {inventory.map(inv => {
          const linkedPid = productLinks[inv.id];
          const linked = linkedPid ? PRODUCTS[linkedPid] : null;
          const wfSteps = linkedPid ? (workflows[linkedPid]||DEFAULT_WORKFLOWS[linkedPid]||[]).length : 0;
          return <div key={inv.id} style={{
            display:'grid', gridTemplateColumns:'1fr 160px 200px 36px',
            gap:'14px', alignItems:'center',
            background:'var(--warm-white)', border:`1px solid ${linked?'var(--sage)':'var(--border)'}`,
            borderRadius:'10px', padding:'12px 18px', transition:'border-color 0.15s'
          }}>
            <div>
              <div style={{ fontWeight:500, fontSize:'14px' }}>{inv.name||inv.title||'Product'}</div>
              <div style={{ fontSize:'11px', fontFamily:'DM Mono', color:'var(--text-muted)', marginTop:'2px' }}>
                SKU: {inv.sku||inv.id||'â€”'} Â· Voorraad: {inv.quantity??inv.stock??'?'} stuks
              </div>
            </div>

            {/* Link to our workflow */}
            <select
              value={linkedPid||''}
              onChange={e => setProductLinks(l => ({...l,[inv.id]:e.target.value||undefined}))}
              style={{ padding:'6px 10px', border:'1px solid var(--border)', borderRadius:'7px', fontSize:'12px', fontFamily:'DM Sans', background:'var(--cream)', outline:'none', cursor:'pointer' }}>
              <option value="">â€” Geen workflow â€”</option>
              {Object.entries(PRODUCTS).map(([pid,p]) => <option key={pid} value={pid}>{p.name}</option>)}
            </select>

            {/* Workflow status */}
            <div style={{ fontSize:'12px', color: linked ? 'var(--sage)' : 'var(--text-muted)', display:'flex', alignItems:'center', gap:'6px' }}>
              {linked ? <>
                <span style={{ width:8, height:8, borderRadius:'50%', background:'var(--sage)', display:'inline-block' }} />
                {linked.name} Â· {wfSteps} stappen
              </> : <span style={{ color:'var(--text-muted)' }}>Niet gekoppeld</span>}
            </div>

            {/* Quick-edit button */}
            <button
              disabled={!linkedPid}
              onClick={() => { if (linkedPid) setActivePid(linkedPid); window.scrollTo({top:999999,behavior:'smooth'}); }}
              title="Bewerk workflow"
              style={{ border:'none', background: linkedPid?'var(--amber)':'var(--flour)', color: linkedPid?'white':'var(--text-muted)', borderRadius:'7px', width:'32px', height:'32px', cursor: linkedPid?'pointer':'default', fontSize:'14px' }}>
              âœ
            </button>
          </div>;
        })}
        {!invLoading && inventory.length===0 && <div className="empty-msg" style={{padding:'30px'}}><div className="icon">ğŸ“¦</div>Geen producten geladen</div>}
      </div>
    </div>

    <div className="divider" />

    {/* â”€â”€ Workflow editor â”€â”€ */}
    <div style={{ display:'flex', alignItems:'center', gap:'12px', margin:'20px 0 16px' }}>
      <h3 style={{ fontFamily:'DM Serif Display', fontSize:'20px', flex:1 }}>Workflows per product</h3>
    </div>

    <div className="wf-product-list">
      {Object.entries(PRODUCTS).map(([pid, prod]) => {
        const wf = workflows[pid] || DEFAULT_WORKFLOWS[pid] || [];
        const isLinked = Object.values(productLinks).includes(pid);
        return <div key={pid} className={`wf-product-row ${activePid===pid?'active':''}`} onClick={()=>setActivePid(pid===activePid?null:pid)}>
          <div className={`step-type-dot dot-${wf[0]?.type||'kneden'}`} />
          <div className="wf-product-name">{prod.name}</div>
          <div className="wf-product-steps">{wf.length} stappen</div>
          {isLinked && <span style={{ fontSize:'10px', fontFamily:'DM Mono', background:'#D1FAE5', color:'#065F46', padding:'2px 7px', borderRadius:'10px' }}>gekoppeld</span>}
          <div style={{ display:'flex', gap:'4px' }}>
            {['T-2','T-1','T0'].map((d,i) => {
              const has = wf.some(s=>s.day===i);
              return <span key={d} style={{ fontSize:'10px', fontFamily:'DM Mono', padding:'2px 6px', borderRadius:'10px', background:has?'var(--amber)':'var(--flour)', color:has?'white':'var(--text-muted)' }}>{d}</span>;
            })}
          </div>
          <span style={{ color:'var(--text-muted)', fontSize:'16px' }}>{activePid===pid?'â–¾':'â€º'}</span>
        </div>;
      })}
    </div>

    {/* Inline editor */}
    {activePid && <div className="wf-editor" style={{ marginTop:'8px' }}>
      <div className="wf-editor-header">
        <h3>{PRODUCTS[activePid]?.name}</h3>
        <button className="btn btn-primary" onClick={()=>setWorkflows(w=>({...w,[activePid]:DEFAULT_WORKFLOWS[activePid]||[]}))}>â†º Herstel standaard</button>
        <button className="btn btn-secondary" onClick={()=>setActivePid(null)}>Sluiten âœ•</button>
      </div>
      <div className="wf-editor-body">
        <div className="wf-step-col-headers">
          <div /><div style={{fontSize:'11px',fontFamily:'DM Mono',color:'var(--text-muted)',textTransform:'uppercase'}}>Stap</div>
          <div style={{fontSize:'11px',fontFamily:'DM Mono',color:'var(--text-muted)',textTransform:'uppercase'}}>Duurtijd</div>
          <div style={{fontSize:'11px',fontFamily:'DM Mono',color:'var(--text-muted)',textTransform:'uppercase'}}>Dag</div>
          <div style={{fontSize:'11px',fontFamily:'DM Mono',color:'var(--text-muted)',textTransform:'uppercase'}}>Venster na vorige</div>
          <div />
        </div>

        {steps.map((step,idx) => <div key={step.id} className="wf-step">
          <div className={`wf-step-num ${step.type}`}>{idx+1}</div>
          <div>
            <select className="wf-step-type-select" value={step.type} onChange={e=>updateStep(step.id,'type',e.target.value)} style={{marginBottom:'4px'}}>
              {STEP_TYPES.map(t=><option key={t} value={t}>{t.charAt(0).toUpperCase()+t.slice(1)}</option>)}
            </select>
            <input className="wf-step-input" value={step.label} onChange={e=>updateStep(step.id,'label',e.target.value)} placeholder="Labelâ€¦" style={{fontSize:'12px',padding:'4px 8px'}} />
          </div>
          <div>
            <div className="wf-step-label">minuten</div>
            <input className="wf-step-input" type="number" min="0" value={step.duration_min} onChange={e=>updateStep(step.id,'duration_min',parseInt(e.target.value)||0)} />
          </div>
          <div>
            <div className="wf-step-label">Dag</div>
            <select className="wf-step-type-select" value={step.day} onChange={e=>updateStep(step.id,'day',parseInt(e.target.value))}>
              <option value={0}>T-2</option><option value={1}>T-1</option><option value={2}>T0 (bakdag)</option>
            </select>
          </div>
          <div>
            <div className="wf-step-label">Min / Max (min)</div>
            <div style={{display:'flex',gap:'4px',alignItems:'center'}}>
              <input className="wf-step-input" type="number" min="0" value={step.min_after??''} placeholder="min" onChange={e=>updateStep(step.id,'min_after',e.target.value===''?null:parseInt(e.target.value))} style={{fontSize:'12px',padding:'4px 6px'}} />
              <span style={{color:'var(--text-muted)',fontSize:'12px',flexShrink:0}}>â€“</span>
              <input className="wf-step-input" type="number" min="0" value={step.max_after??''} placeholder="max" onChange={e=>updateStep(step.id,'max_after',e.target.value===''?null:parseInt(e.target.value))} style={{fontSize:'12px',padding:'4px 6px'}} />
            </div>
          </div>
          <div style={{display:'flex',flexDirection:'column',gap:'3px'}}>
            <button onClick={()=>moveStep(step.id,-1)} style={{border:'none',background:'none',cursor:'pointer',fontSize:'13px',color:'var(--text-muted)',padding:'2px'}}>â–²</button>
            <button onClick={()=>moveStep(step.id,1)}  style={{border:'none',background:'none',cursor:'pointer',fontSize:'13px',color:'var(--text-muted)',padding:'2px'}}>â–¼</button>
            <button onClick={()=>removeStep(step.id)}  style={{border:'none',background:'none',cursor:'pointer',fontSize:'13px',color:'#DC2626',padding:'2px'}}>âœ•</button>
          </div>
        </div>)}

        <button className="wf-add-btn" onClick={addStep}>+ Stap toevoegen</button>
      </div>
    </div>}
  </div>;
}

// â”€â”€â”€ 3-day Planning Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PlanningPage({ orders, workflows }) {
  const [bakDate, setBakDate] = useState(new Date().toISOString().split('T')[0]);

  // Derive T-2, T-1, T0 dates
  const t0 = new Date(bakDate);
  const t1 = new Date(bakDate); t1.setDate(t1.getDate() - 1);
  const t2 = new Date(bakDate); t2.setDate(t2.getDate() - 2);

  const fmtDate = d => d.toLocaleDateString('nl-BE', { weekday: 'short', day: 'numeric', month: 'short' });

  // Collect products needed from orders on bakDate
  const needed = {};
  (orders || []).forEach(o => {
    if (!(o.delivery_date || o.date || '').startsWith(bakDate)) return;
    (o.items || o.order_items || []).forEach(item => {
      const pid = matchProduct(item.name || item.product_name);
      if (!pid) return;
      needed[pid] = (needed[pid] || 0) + (item.quantity || item.qty || 1);
    });
  });

  // Build steps per day
  const daySteps = [[], [], []]; // index = day (0=T-2, 1=T-1, 2=T0)
  Object.entries(needed).forEach(([pid, qty]) => {
    const wf = workflows[pid] || DEFAULT_WORKFLOWS[pid] || [];
    wf.forEach(step => {
      daySteps[step.day].push({ ...step, pid, qty, prodName: PRODUCTS[pid]?.name || pid });
    });
  });

  const dayColors = ['t2', 't1', 't0'];
  const dayLabels = ['T-2 Â· Voorbereiding', 'T-1 Â· Rijsdag', 'T0 Â· Bakdag'];
  const dayDates = [t2, t1, t0];

  const fmtWindow = step => {
    if (step.min_after === null && step.max_after === null) return 'Start naar keuze';
    if (step.min_after === null) return `Max ${step.max_after} min na vorige`;
    if (step.max_after === null) return `Min ${step.min_after} min na vorige`;
    return `${step.min_after} â€“ ${step.max_after} min na vorige`;
  };

  return <div className="page-enter">
    <div className="page-header">
      <h2>3-Daags Productieplan</h2>
      <p>Overzicht van alle stappen op T-2, T-1 en T0</p>
    </div>

    <div className="toolbar">
      <label style={{ fontSize: '12px', fontFamily: 'DM Mono', color: 'var(--text-muted)' }}>BAKDAG (T0)</label>
      <input type="date" className="search-input" value={bakDate} onChange={e => setBakDate(e.target.value)} style={{ width: '160px' }} />
      <div className="toolbar-spacer" />
      <button className="btn btn-secondary" onClick={() => window.print()}>ğŸ–¨ï¸ Afdrukken</button>
    </div>

    {Object.keys(needed).length === 0 && <div className="error-msg" style={{ background: '#FEF3C7', borderColor: '#FDE68A', color: '#92400E', marginBottom: '20px' }}>
      âš ï¸ Geen bestellingen gevonden voor {new Date(bakDate).toLocaleDateString('nl-BE', { day: 'numeric', month: 'long' })}. De demo toont een voorbeeldplan met alle producten.
    </div>}

    {/* If no orders, show demo with one of each */}
    {(() => {
      const displayNeeded = Object.keys(needed).length > 0 ? needed : { 'spelt-groot': 9, 'rogge': 15, 'wit-klein': 12, 'pistolet': 25 };
      const demoSteps = [[], [], []];
      Object.entries(displayNeeded).forEach(([pid, qty]) => {
        const wf = workflows[pid] || DEFAULT_WORKFLOWS[pid] || [];
        wf.forEach(step => { demoSteps[step.day].push({ ...step, pid, qty, prodName: PRODUCTS[pid]?.name || pid }); });
      });

      return <div className="plan3-layout">
        {[0,1,2].map(di => <div key={di} className="day-col">
          <div className={`day-col-header ${dayColors[di]}`}>
            <div className={`day-col-label ${dayColors[di]}`}>{dayLabels[di]}</div>
            <div className="day-col-date">{fmtDate(dayDates[di])}</div>
          </div>
          <div className="day-col-body">
            {demoSteps[di].length === 0 && <div className="plan-empty-day">Geen stappen op deze dag</div>}
            {demoSteps[di].map((step, i) => <div key={i} className={`plan-step-block ${step.type}`}>
              <div className="plan-step-product">{step.prodName} Â· {step.qty} st.</div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                <span className={`step-type-dot dot-${step.type}`} />
                <div className="plan-step-name">{step.label}</div>
              </div>
              {step.duration_min > 0 && <div className="plan-step-duration">â± {step.duration_min} min</div>}
              <div className="plan-step-window">ğŸ• {fmtWindow(step)}</div>
            </div>)}
          </div>
        </div>)}
      </div>;
    })()}
  </div>;
}

// â”€â”€â”€ Shared helper: build needed products from orders for a given bakDate â”€â”€â”€â”€â”€
function getNeededForBakDate(orders, bakDate) {
  const needed = {};
  (orders || []).forEach(o => {
    if (!(o.delivery_date || o.date || '').startsWith(bakDate)) return;
    (o.items || o.order_items || []).forEach(item => {
      const pid = matchProduct(item.name || item.product_name);
      if (!pid) return;
      needed[pid] = (needed[pid] || 0) + (item.quantity || item.qty || 1);
    });
  });
  return needed;
}

// â”€â”€â”€ FLOUR / INGREDIENT BREAKDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FLOUR_NAMES = { spelt: 'Speltmeel', spelt_energy: 'Spelt Energy meel', wit: 'Witte bloem', bruin: 'Bruine bloem', rogge: 'Roggemeel' };

// For a product, compute full ingredient list with amounts
function getIngredientsForProduct(pid, qty) {
  const prod = PRODUCTS[pid];
  if (!prod) return [];
  const flourKg = prod.flour_kg * qty;
  const waterKg = flourKg * 0.75; // typical hydration 75%
  const saltKg  = flourKg * 0.02;
  const desemKg = flourKg * 0.20;
  const rows = [
    { name: FLOUR_NAMES[prod.flour_type] || prod.flour_type, amount: flourKg, unit: 'kg', cost_kg: prod.flour_cost_kg },
    { name: 'Water',       amount: waterKg, unit: 'kg', cost_kg: 0 },
    { name: 'Zout',        amount: saltKg,  unit: 'kg', cost_kg: 0.40 },
    { name: 'Zuurdesem',   amount: desemKg, unit: 'kg', cost_kg: 0 },
  ];
  if (pid === 'vijg-noot') rows.push({ name: 'Vijgen/Noten mix', amount: flourKg * 0.30, unit: 'kg', cost_kg: 3.50 });
  if (pid === 'kaneelkoek') rows.push({ name: 'Kaneelsuiker', amount: flourKg * 0.40, unit: 'kg', cost_kg: 2.20 });
  return rows;
}

// â”€â”€â”€ IngredientsPage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function IngredientsPage({ orders, workflows, products: PRODUCTS }) {
  PRODUCTS = PRODUCTS || DEFAULT_PRODUCTS;
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

  // Products starting production on T-2 for this bakdate = need their kneden step today
  // We show all products whose T-2 day = selected date (i.e. bakDate = date+2)
  const bakDate = (() => { const d = new Date(date); d.setDate(d.getDate() + 2); return d.toISOString().split('T')[0]; })();
  const needed  = getNeededForBakDate(orders, bakDate);

  // Also check T-1 products starting on selected date
  const bakDateT1 = (() => { const d = new Date(date); d.setDate(d.getDate() + 1); return d.toISOString().split('T')[0]; })();
  const neededT1  = getNeededForBakDate(orders, bakDateT1);

  // Filter to products whose first step is on day 0 (T-2) â†’ kneden starts today
  function getStartingToday(neededMap, dayOffset) {
    return Object.entries(neededMap).filter(([pid]) => {
      const wf = workflows[pid] || DEFAULT_WORKFLOWS[pid] || [];
      const firstKneden = wf.find(s => s.type === 'kneden');
      return firstKneden && firstKneden.day === dayOffset;
    });
  }

  const startingT2 = getStartingToday(needed, 0);   // day=0 = T-2
  const startingT1 = getStartingToday(neededT1, 1); // day=1 = T-1 (pistolets, kaneelkoek)

  // Grand totals across all flour types
  const grandTotals = {};
  [...startingT2, ...startingT1].forEach(([pid, qty]) => {
    getIngredientsForProduct(pid, qty).forEach(ing => {
      grandTotals[ing.name] = (grandTotals[ing.name] || { amount: 0, unit: ing.unit });
      grandTotals[ing.name].amount += ing.amount;
    });
  });

  const allProducts = [...startingT2.map(e => ({ ...e, label: 'T-2', cls: 't2' })),
                       ...startingT1.map(e => ({ ...e, label: 'T-1', cls: 't1' }))];

  const fmtKg = n => n < 0.1 ? (n * 1000).toFixed(0) + ' g' : n.toFixed(3) + ' kg';

  return <div className="page-enter">
    <div className="page-header">
      <h2>IngrediÃ«ntenlijst</h2>
      <p>Afweeglijst voor broden die vandaag starten met kneden</p>
    </div>

    <div className="toolbar">
      <label style={{ fontSize: '12px', fontFamily: 'DM Mono', color: 'var(--text-muted)' }}>DATUM</label>
      <input type="date" className="search-input" value={date} onChange={e => setDate(e.target.value)} style={{ width: '160px' }} />
      <div className="toolbar-spacer" />
      <button className="btn btn-secondary" onClick={() => window.print()}>ğŸ–¨ï¸ Afdrukken</button>
    </div>

    {allProducts.length === 0 && <div className="empty-msg"><div className="icon">âš–ï¸</div>
      Geen broden starten vandaag met productie.<br/>
      <span style={{fontSize:'13px'}}>Selecteer een dag waarop T-2 of T-1 knedewerk gepland staat.</span>
    </div>}

    {allProducts.map(([pid, qty, , , label, cls]) => {
      // destructure correctly
      return null;
    })}

    {allProducts.map(({ 0: pid, 1: qty, label, cls }) => {
      const prod = PRODUCTS[pid];
      const ings = getIngredientsForProduct(pid, qty);
      const totalCost = ings.reduce((s, i) => s + i.amount * i.cost_kg, 0);
      return <div key={pid} className="ing-section">
        <div className="ing-section-header">
          <span className={`cal-role-badge ${cls}`}>{label}</span>
          <h3>{prod.name}</h3>
          <span className="qty-badge">{qty} broden</span>
          <span style={{ fontFamily: 'DM Mono', fontSize: '12px', color: 'rgba(255,255,255,0.5)' }}>
            â‰ˆ {fmt(totalCost)} ingrediÃ«nten
          </span>
        </div>
        <table className="ing-table">
          <thead>
            <tr>
              <th>IngrediÃ«nt</th>
              <th>Per brood</th>
              <th>Totaal ({qty} broden)</th>
              <th>Kost</th>
              <th>â˜‘</th>
            </tr>
          </thead>
          <tbody>
            {ings.map((ing, i) => <tr key={i}>
              <td style={{ fontWeight: 500 }}>{ing.name}</td>
              <td className="ing-amount">{fmtKg(ing.amount / qty)}</td>
              <td className="ing-amount" style={{ color: 'var(--amber)' }}>{fmtKg(ing.amount)}</td>
              <td style={{ fontFamily: 'DM Mono', fontSize: '12px', color: 'var(--text-muted)' }}>
                {ing.cost_kg > 0 ? fmt(ing.amount * ing.cost_kg) : 'â€”'}
              </td>
              <td>
                <input type="checkbox" style={{ accentColor: 'var(--amber)', width: '16px', height: '16px' }} />
              </td>
            </tr>)}
            <tr className="ing-subtotal-row">
              <td colSpan={2}>Subtotaal</td>
              <td colSpan={2}>{fmt(totalCost)}</td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>;
    })}

    {Object.keys(grandTotals).length > 0 && <>
      <h3 style={{ fontFamily: 'DM Serif Display', fontSize: '20px', marginBottom: '12px', marginTop: '8px' }}>Eindtotalen</h3>
      <div className="ing-grand-total">
        {Object.entries(grandTotals).map(([name, { amount, unit }]) => <div key={name} className="ing-grand-total-item">
          <div className="label">{name}</div>
          <div className="val">{amount < 0.1 ? (amount * 1000).toFixed(0) : amount.toFixed(2)}</div>
          <div className="unit">{amount < 0.1 ? 'g' : 'kg'}</div>
        </div>)}
      </div>
    </>}
  </div>;
}

// â”€â”€â”€ CalendarPage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CalendarPage({ orders, workflows, products: PRODUCTS, onNavigate }) {
  PRODUCTS = PRODUCTS || DEFAULT_PRODUCTS;
  const todayStr = new Date().toISOString().split('T')[0];
  const [weekStart, setWeekStart] = useState(() => {
    const d = new Date();
    d.setDate(d.getDate() - d.getDay() + 1); // Monday
    return d.toISOString().split('T')[0];
  });
  const [selectedDay, setSelectedDay] = useState(todayStr);

  // Build 7 days from weekStart
  const days = Array.from({ length: 7 }, (_, i) => {
    const d = new Date(weekStart);
    d.setDate(d.getDate() + i);
    return d.toISOString().split('T')[0];
  });

  const DAY_NAMES = ['Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za', 'Zo'];

  function prevWeek() {
    const d = new Date(weekStart); d.setDate(d.getDate() - 7);
    setWeekStart(d.toISOString().split('T')[0]);
  }
  function nextWeek() {
    const d = new Date(weekStart); d.setDate(d.getDate() + 7);
    setWeekStart(d.toISOString().split('T')[0]);
  }

  // For each day, compute activities across all bake cycles it's part of
  // A day can be: T-2 for bakDate+2, T-1 for bakDate+1, T0 for bakDate
  function getDayActivities(dayStr) {
    const activities = []; // { bakDate, pid, qty, step, role }

    for (let offset = 0; offset <= 2; offset++) {
      const bakDate = (() => { const d = new Date(dayStr); d.setDate(d.getDate() + offset); return d.toISOString().split('T')[0]; })();
      const needed  = getNeededForBakDate(orders, bakDate);
      const dayRole = 2 - offset; // if offset=0 â†’ this day is T-2 (day=0), offset=2 â†’ T-0 (day=2)

      Object.entries(needed).forEach(([pid, qty]) => {
        const wf = workflows[pid] || DEFAULT_WORKFLOWS[pid] || [];
        wf.filter(s => s.day === dayRole).forEach(step => {
          activities.push({ bakDate, pid, qty, step, role: dayRole });
        });
      });
    }
    return activities;
  }

  // Build oven schedule for T0: group bakken steps, pack into sessions
  function getOvenSchedule(dayStr) {
    const needed = getNeededForBakDate(orders, dayStr);
    const sessions = [];
    let startMin = 7 * 60; // start at 07:00

    Object.entries(needed).forEach(([pid, qty]) => {
      const prod = PRODUCTS[pid];
      if (!prod) return;
      const numBatches = Math.ceil(qty / prod.per_session);
      for (let b = 0; b < numBatches; b++) {
        const batchQty = b < numBatches - 1 ? prod.per_session : qty - b * prod.per_session;
        sessions.push({ pid, prod, qty: batchQty, duration: prod.session_min, startMin });
        startMin += prod.session_min + 10; // 10 min between sessions
      }
    });

    return sessions;
  }

  function fmtMin(totalMin) {
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }

  const roleLabel = { 0: 'T-2', 1: 'T-1', 2: 'T0' };
  const roleCls   = { 0: 't2',  1: 't1',  2: 't0' };

  // For week card: summarise
  function getWeekCardInfo(dayStr) {
    const acts = getDayActivities(dayStr);
    const roles = [...new Set(acts.map(a => a.role))].sort();
    const hasBake = acts.some(a => a.step.type === 'bakken' && a.role === 2);
    return { acts, roles, hasBake, isEmpty: acts.length === 0 };
  }

  // Selected day full detail
  const selActivities = getDayActivities(selectedDay);
  const grouped = {};
  selActivities.forEach(a => {
    const key = `${a.role}-${a.bakDate}`;
    if (!grouped[key]) grouped[key] = { role: a.role, bakDate: a.bakDate, items: [] };
    grouped[key].items.push(a);
  });
  const ovenSessions = getOvenSchedule(selectedDay);

  const selDate = new Date(selectedDay);
  const selDateFmt = selDate.toLocaleDateString('nl-BE', { weekday: 'long', day: 'numeric', month: 'long' });

  // Count active moments: unique "action needed" blocks (excluding passive rijzen)
  function countActiveMoments(acts) {
    return acts.filter(a => a.step.type !== 'rijzen').length;
  }

  return <div className="page-enter">
    <div className="page-header">
      <h2>Productiekalender</h2>
      <p>Weekoverzicht met geoptimaliseerd dagschema</p>
    </div>

    {/* Week navigation */}
    <div className="cal-nav">
      <button className="btn btn-secondary" onClick={prevWeek}>â† Vorige week</button>
      <h3>{new Date(days[0]).toLocaleDateString('nl-BE', { day: 'numeric', month: 'long' })} â€“ {new Date(days[6]).toLocaleDateString('nl-BE', { day: 'numeric', month: 'long', year: 'numeric' })}</h3>
      <button className="btn btn-secondary" onClick={nextWeek}>Volgende week â†’</button>
      <button className="btn btn-primary" onClick={() => { const d = new Date(); d.setDate(d.getDate() - d.getDay() + 1); setWeekStart(d.toISOString().split('T')[0]); setSelectedDay(todayStr); }}>Vandaag</button>
    </div>

    {/* Week summary cards */}
    <div className="cal-week-summary">
      {days.map((day, i) => {
        const info = getWeekCardInfo(day);
        const isToday = day === todayStr;
        const isSel   = day === selectedDay;
        return <div key={day}
          className={`cal-day-card ${isToday ? 'today' : ''} ${isSel ? 'selected' : ''} ${info.isEmpty ? 'empty' : ''}`}
          onClick={() => setSelectedDay(day)}>
          <div className="cal-day-name">{DAY_NAMES[i]}</div>
          <div className="cal-day-num">{new Date(day).getDate()}</div>
          <div className="cal-day-chips">
            {info.roles.map(r => {
              // Count unique bakDates for this role
              const bds = [...new Set(selActivities.filter(a => a.role === r).map(a => a.bakDate))];
              const count = getDayActivities(day).filter(a => a.role === r).length;
              return count > 0 && <span key={r} className={`cal-chip ${roleCls[r]}`}>{roleLabel[r]} Â· {count} stap{count > 1 ? 'pen' : ''}</span>;
            })}
            {info.hasBake && <span className="cal-chip bake">ğŸ”¥ Bakken</span>}
            {info.isEmpty && <span style={{ fontSize: '11px', color: 'var(--text-muted)' }}>Vrij</span>}
          </div>
        </div>;
      })}
    </div>

    {/* Day detail */}
    <div className="cal-day-detail">
      <div className="cal-detail-header">
        <h3>{selDateFmt}</h3>
        {selActivities.length > 0 && <>
          <span style={{ fontFamily: 'DM Mono', fontSize: '12px', background: 'rgba(255,255,255,0.1)', padding: '4px 10px', borderRadius: '8px' }}>
            {countActiveMoments(selActivities)} actieve momenten
          </span>
          <span style={{ fontFamily: 'DM Mono', fontSize: '12px', background: 'rgba(200,132,10,0.3)', padding: '4px 10px', borderRadius: '8px', color: 'var(--amber-light)' }}>
            {selActivities.length} stappen totaal
          </span>
        </>}
      </div>

      <div className="cal-detail-body">
        {selActivities.length === 0 && <div className="plan-empty-day" style={{ padding: '40px' }}>
          ğŸ‰ Geen productie vandaag
        </div>}

        {/* Oven schedule (T0 only) */}
        {ovenSessions.length > 0 && <div className="cal-block-group">
          <div className="cal-block-group-header">
            <span>ğŸ”¥ Ovenschema (geoptimaliseerd)</span>
            <span className={`cal-role-badge t0`}>T0</span>
          </div>
          {ovenSessions.map((s, i) => <div key={i} className="cal-oven-block">
            <strong>{fmtMin(s.startMin)} â€“ {fmtMin(s.startMin + s.duration)}</strong>
            &nbsp;Â·&nbsp;{s.prod.name}
            &nbsp;Â·&nbsp;<span style={{ color: 'var(--text-muted)' }}>{s.qty} broden Â· {s.duration} min Â· {fmt(s.prod.session_cost)} stookkosten</span>
          </div>)}
        </div>}

        {/* Group by role & bakDate */}
        {Object.values(grouped).sort((a, b) => a.role - b.role || a.bakDate.localeCompare(b.bakDate)).map(group => {
          const bakDateFmt = new Date(group.bakDate).toLocaleDateString('nl-BE', { weekday: 'short', day: 'numeric', month: 'short' });
          return <div key={`${group.role}-${group.bakDate}`} className="cal-block-group">
            <div className="cal-block-group-header">
              <span className={`cal-role-badge ${roleCls[group.role]}`}>{roleLabel[group.role]}</span>
              <span>voor bakdag {bakDateFmt}</span>
            </div>
            {group.items.map((a, i) => {
              const isActive = a.step.type !== 'rijzen';
              return <div key={i} className="cal-activity-row">
                <div className="cal-activity-time">
                  <span className={`step-type-dot dot-${a.step.type}`} style={{ marginRight: '4px' }} />
                  {a.step.duration_min > 0 ? `${a.step.duration_min} min` : 'passief'}
                </div>
                <div className="cal-activity-content">
                  <div className="cal-activity-title" style={{ color: isActive ? 'var(--dark)' : 'var(--text-muted)' }}>
                    {isActive ? 'âš¡ ' : 'ğŸ’¤ '}{a.step.label}
                    <span style={{ fontWeight: 400, color: 'var(--text-muted)', fontSize: '12px', marginLeft: '8px' }}>â€” {PRODUCTS[a.pid]?.name} Â· {a.qty} st.</span>
                  </div>
                  {(a.step.min_after || a.step.max_after) && <div className="cal-activity-sub">
                    Venster: {a.step.min_after ?? '?'} â€“ {a.step.max_after ?? '?'} min na vorige stap
                  </div>}
                </div>
                <div>
                  <span className={`badge ${a.step.type === 'bakken' ? 'badge-production' : 'badge-delivered'}`}>{a.step.type}</span>
                </div>
              </div>;
            })}
          </div>;
        })}
      </div>
    </div>
  </div>;
}

// â”€â”€â”€ SettingsPage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SettingsPage() {
  const [key, setKey] = useState('');
  useEffect(() => { LOCAL.load('settings').then(d => { if (d?.api_key) { setKey(d.api_key); API_KEY = d.api_key; } }); }, []);
  const [saved, setSaved] = useState(false);
  const [testing, setTesting] = useState(false);
  const [testResult, setTestResult] = useState(null);
  const [show, setShow] = useState(false);

  function save() {
    API_KEY = key.trim();
    LOCAL.save('settings', { api_key: API_KEY });
    setSaved(true);
    setTestResult(null);
    setTimeout(() => setSaved(false), 2500);
  }

  async function test() {
    setTesting(true); setTestResult(null);
    try {
      const data = await apiGet('/me');
      setTestResult({ ok: true, msg: `âœ“ Verbonden als: ${data.name || data.email || 'onbekend'}` });
    } catch (e) {
      setTestResult({ ok: false, msg: `âœ— Fout: ${e.message}` });
    } finally { setTesting(false); }
  }

  function clear() {
    setKey(''); API_KEY = '';
    LOCAL.save('settings', { api_key: '' });
    setTestResult(null);
  }

  const hasKey = key.trim().length > 0;

  return <div className="page-enter">
    <div className="page-header">
      <h2>Instellingen</h2>
      <p>Take App API-configuratie</p>
    </div>

    <div style={{ maxWidth: '560px' }}>
      <div className="card">
        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '20px' }}>
          <div style={{ width: '36px', height: '36px', background: 'var(--dark)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px' }}>ğŸ”‘</div>
          <div>
            <div style={{ fontWeight: 500, fontSize: '15px' }}>Take App API-sleutel</div>
            <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Vind je sleutel via Instellingen â†’ Integraties in Take App</div>
          </div>
        </div>

        <div style={{ position: 'relative', marginBottom: '12px' }}>
          <input
            type={show ? 'text' : 'password'}
            value={key}
            onChange={e => { setKey(e.target.value); setTestResult(null); }}
            placeholder="Plak hier je API-sleutelâ€¦"
            style={{
              width: '100%', padding: '10px 44px 10px 14px',
              border: `1px solid ${hasKey ? 'var(--sage)' : 'var(--border)'}`,
              borderRadius: '8px', fontSize: '13px', fontFamily: 'DM Mono, monospace',
              background: 'var(--cream)', color: 'var(--dark)', outline: 'none',
              letterSpacing: show ? '0.02em' : '0.12em'
            }}
            onKeyDown={e => e.key === 'Enter' && save()}
          />
          <button onClick={() => setShow(s => !s)} style={{
            position: 'absolute', right: '10px', top: '50%', transform: 'translateY(-50%)',
            border: 'none', background: 'none', cursor: 'pointer', fontSize: '16px', color: 'var(--text-muted)'
          }}>{show ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'}</button>
        </div>

        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
          <button className="btn btn-primary" onClick={save} disabled={!hasKey}>
            {saved ? 'âœ“ Opgeslagen' : 'Opslaan'}
          </button>
          <button className="btn btn-secondary" onClick={test} disabled={!hasKey || testing}>
            {testing ? 'â€¦' : 'ğŸ”Œ Verbinding testen'}
          </button>
          {hasKey && <button className="btn btn-danger" onClick={clear}>Verwijderen</button>}
        </div>

        {testResult && <div style={{
          marginTop: '14px', padding: '10px 14px', borderRadius: '8px',
          background: testResult.ok ? '#D1FAE5' : '#FEE2E2',
          color: testResult.ok ? '#065F46' : '#991B1B',
          border: `1px solid ${testResult.ok ? '#6EE7B7' : '#FECACA'}`,
          fontFamily: 'DM Mono, monospace', fontSize: '13px'
        }}>{testResult.msg}</div>}
      </div>

      <div className="card" style={{ marginTop: '16px' }}>
        <div style={{ fontWeight: 500, marginBottom: '10px', fontSize: '14px' }}>â„¹ï¸ Over de opslag</div>
        <p style={{ fontSize: '13px', color: 'var(--text-muted)', lineHeight: 1.6 }}>
          Je sleutel wordt opgeslagen in de <strong>sessie</strong> van je browser â€” hij verdwijnt automatisch wanneer je het tabblad sluit.
          Hij wordt nooit naar een externe server gestuurd, enkel rechtstreeks naar de Take App API.
        </p>
      </div>
    </div>
  </div>;
}

// Mock inventory for when API fails
const MOCK_INVENTORY = [
  { id: 'inv-1', name: 'Spelt Groot',       sku: 'SG-001', quantity: 18 },
  { id: 'inv-2', name: 'Spelt Energy Groot', sku: 'SEG-001', quantity: 9 },
  { id: 'inv-3', name: 'Wit Groot',          sku: 'WG-001', quantity: 27 },
  { id: 'inv-4', name: 'Bruin Groot',        sku: 'BG-001', quantity: 18 },
  { id: 'inv-5', name: 'Rogge',              sku: 'RG-001', quantity: 15 },
  { id: 'inv-6', name: 'Spelt Klein',        sku: 'SK-001', quantity: 12 },
  { id: 'inv-7', name: 'Wit Klein',          sku: 'WK-001', quantity: 24 },
  { id: 'inv-8', name: 'Vijg/Noot',          sku: 'VN-001', quantity: 12 },
  { id: 'inv-9', name: 'Pistolet',           sku: 'PS-001', quantity: 50 },
  { id: 'inv-10',name: 'Kaneelkoek',         sku: 'KK-001', quantity: 21 },
];

// Mock orders for when API fails
const MOCK_ORDERS = [
  { id: 'ORD-0001', customer_name: 'Marie Janssen', delivery_date: new Date().toISOString().split('T')[0], status: 'new', items: [{ name: 'Spelt Groot', quantity: 2, price: 5.50 }, { name: 'Rogge', quantity: 1, price: 5.20 }], total: 16.20 },
  { id: 'ORD-0002', customer_name: 'Bakkerij De Molen', delivery_date: new Date().toISOString().split('T')[0], status: 'confirmed', customer_type: 'b2b', items: [{ name: 'Wit Groot', quantity: 10, price: 3.00 }, { name: 'Bruin Groot', quantity: 5, price: 3.00 }], total: 45.00 },
  { id: 'ORD-0003', customer_name: 'Pieter De Smet', delivery_date: new Date().toISOString().split('T')[0], status: 'ready', items: [{ name: 'Vijg/Noot', quantity: 1, price: 5.90 }, { name: 'Kaneelkoek', quantity: 2, price: 2.80 }], total: 11.50 },
  { id: 'ORD-0004', customer_name: 'Restaurant Het Anker', delivery_date: new Date().toISOString().split('T')[0], status: 'new', customer_type: 'b2b', items: [{ name: 'Pistolet', quantity: 30, price: 0.90 }], total: 27.00 },
  { id: 'ORD-0005', customer_name: 'Els Vermeersch', delivery_date: new Date(Date.now() + 86400000).toISOString().split('T')[0], status: 'new', items: [{ name: 'Spelt Energy Groot', quantity: 1, price: 5.90 }], total: 5.90 },
];

// â”€â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [page, setPage]               = useState('bestellingen');
  const [orders, setOrders]           = useState([]);
  const [workflows, setWorkflows]     = useState({});
  const [products, setProducts]       = useState(null);
  const [inventory, setInventory]     = useState(null);
  const [productLinks, setProductLinks] = useState({});
  const [loaded, setLoaded]           = useState(false);

  // â”€â”€ Boot: load everything from server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    async function boot() {
      // Load settings (API key)
      const settings = await LOCAL.load('settings');
      if (settings?.api_key) API_KEY = settings.api_key;

      // Load persistent data
      const [wf, prods, inv, manualOrders, links] = await Promise.all([
        LOCAL.load('workflows'),
        LOCAL.load('products'),
        LOCAL.load('inventory'),
        LOCAL.load('orders'),
        LOCAL.load('links'),
      ]);

      if (wf)           setWorkflows(wf);
      if (prods)        setProducts(prods);
      if (inv)          setInventory(inv);
      if (links)        setProductLinks(links);

      // Merge manual orders + Take App orders
      const manual = (manualOrders || []).map(o => ({ ...o, source: 'manual' }));
      setOrders(manual);

      setLoaded(true);

      // Then try Take App
      if (API_KEY) {
        apiGet('/orders').then(data => {
          const apiOrders = (data.orders || data || []).map(o => ({ ...o, source: 'takeapp' }));
          setOrders(prev => [...apiOrders, ...prev.filter(o => o.source === 'manual')]);
        }).catch(() => {});
      }
    }
    boot();
  }, []);

  // â”€â”€ Auto-save whenever data changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const isFirst = React.useRef(true);
  useEffect(() => {
    if (!loaded) return;
    if (isFirst.current) { isFirst.current = false; return; }
    LOCAL.save('workflows', workflows);
  }, [workflows]);

  useEffect(() => {
    if (!loaded) return;
    const manual = orders.filter(o => o.source === 'manual');
    LOCAL.save('orders', manual);
  }, [orders]);

  useEffect(() => {
    if (!loaded) return;
    LOCAL.save('links', productLinks);
  }, [productLinks]);

  const PRODUCTS = products || DEFAULT_PRODUCTS;
  const INGREDIENTS_DATA = inventory || DEFAULT_INVENTORY;

  const pages = {
    bestellingen: <BestellingenPage orders={orders} setOrders={setOrders} products={PRODUCTS} />,
    kalender:     <CalendarPage orders={orders} workflows={workflows} products={PRODUCTS} onNavigate={setPage} />,
    ingredienten: <IngredientsPage orders={orders} workflows={workflows} products={PRODUCTS} />,
    workflows:    <WorkflowPage workflows={workflows} setWorkflows={setWorkflows}
                    productLinks={productLinks} setProductLinks={setProductLinks}
                    products={PRODUCTS} />,
    timers:       <TimersPage />,
    inventory:    <InventoryPage ingredients={INGREDIENTS_DATA} setIngredients={data => { setInventory(data); LOCAL.save('inventory', data); }} />,
    labels:       <LabelsPage products={PRODUCTS} />,
    settings:     <SettingsPage />,
  };

  if (!loaded) return <div style={{ display:'flex', alignItems:'center', justifyContent:'center', height:'100vh', fontFamily:'DM Serif Display, serif', fontSize:'24px', color:'var(--text-muted)', flexDirection:'column', gap:'16px' }}>
    <div className="spinner" />
    Buurtbrood ladenâ€¦
  </div>;

  return <div className="app">
    <nav className="sidebar">
      <div className="sidebar-brand">
        <img className="sidebar-logo" src="https://emofly.b-cdn.net/hbd_exvhac6ayb3ZKT/width:640/plain/https://storage.googleapis.com/takeapp/media/cmhuetmcl000f04jv2xro1r81.jpg" alt="Buurtbrood" />
        <h1>Buurtbrood<br />planner</h1>
        <p>Artisanaal Zuurdesem</p>
      </div>
      <div className="sidebar-nav">
        <div className="nav-section-label">Orders</div>
        <NavBtn icon="ğŸ“‹" label="Bestellingen"       active={page==='bestellingen'} onClick={()=>setPage('bestellingen')} />

        <div className="nav-section-label">Productie</div>
        <NavBtn icon="ğŸ“…" label="Kalender"           active={page==='kalender'}     onClick={()=>setPage('kalender')} />
        <NavBtn icon="âš–ï¸" label="IngrediÃ«ntenlijst"  active={page==='ingredienten'} onClick={()=>setPage('ingredienten')} />
        <NavBtn icon="ğŸ" label="Bakinstructies"     active={page==='workflows'}    onClick={()=>setPage('workflows')} />
        <NavBtn icon="â±ï¸" label="Timers"             active={page==='timers'}       onClick={()=>setPage('timers')} />

        <div className="nav-section-label">Beheer</div>
        <NavBtn icon="ğŸŒ¾" label="Voorraad"           active={page==='inventory'}    onClick={()=>setPage('inventory')} />
        <NavBtn icon="ğŸ·ï¸" label="Etiketten"          active={page==='labels'}       onClick={()=>setPage('labels')} />
        <NavBtn icon="âš™ï¸" label="Instellingen"       active={page==='settings'}     onClick={()=>setPage('settings')} />
      </div>
      <div style={{ padding:'16px 24px', borderTop:'1px solid rgba(255,255,255,0.08)' }}>
        <div style={{ fontSize:'10px', fontFamily:'DM Mono', color:'rgba(255,255,255,0.2)', lineHeight:1.5 }}>
          Take App API<br />
          <span style={{ color: API_KEY ? 'rgba(100,220,120,0.7)' : 'rgba(255,100,100,0.6)' }}>
            {API_KEY ? 'â— verbonden' : 'â—‹ geen sleutel'}
          </span>
        </div>
      </div>
    </nav>
    <main className="main">
      {pages[page]}
    </main>
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
